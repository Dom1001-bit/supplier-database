<!DOCTYPE html>
<html class="dark">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Database</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/U4WPjmA.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    :root {
        --bg-main: #111827;
        --bg-secondary: #1f2937;
        --bg-glass: rgba(31, 41, 55, 0.6);
        --text-main: #e5e7eb;
        --text-secondary: #9ca3af;
        --border-color: rgba(55, 65, 81, 0.8);
        --accent-color: #4f46e5;
        --accent-hover: #4338ca;
        --card-bg: #1f2937;
    }

    html.light-mode {
        --bg-main: #f9fafb;
        --bg-secondary: #f3f4f6;
        --bg-glass: rgba(255, 255, 255, 0.7);
        --text-main: #1f2937;
        --text-secondary: #4b5563;
        --border-color: rgba(209, 213, 219, 0.8);
        --accent-color: #4f46e5;
        --accent-hover: #5a53e0;
        --card-bg: #ffffff;
    }

    body {  
        font-family: 'Inter', sans-serif;  
        background-color: var(--bg-main);
        color: var(--text-main);
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .glass-effect {
        background-color: var(--bg-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border-color);
    }

    .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .skeleton-card { background-color: var(--bg-secondary); border-radius: 0.75rem; overflow: hidden; border: 1px solid var(--border-color); }
    .skeleton-image { background-color: var(--text-secondary); opacity: 0.3; height: 12rem; }
    .skeleton-text { background-color: var(--text-secondary); opacity: 0.3; height: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; }
    @keyframes pulse { 50% { opacity: .5; } }
    .skeleton-card, .skeleton-image, .skeleton-text { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    .result-card { 
        opacity: 0; 
        transform: translateY(20px); 
        animation: card-fade-in 0.5s forwards; 
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    .result-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
    }
    html.dark .result-card:hover {
        box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.2), 0 8px 10px -6px rgba(79, 70, 229, 0.1);
        border-color: var(--accent-color);
    }
    @keyframes card-fade-in { to { opacity: 1; transform: translateY(0); } }
    
    .tab-button {
        position: relative;
        color: var(--text-secondary);
        transition: color 0.3s ease;
    }
    .tab-button:hover { color: var(--text-main); }
    .tab-button.active { color: var(--accent-color); font-weight: 600; }
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--accent-color);
    }
    
    .btn-primary {
        background-color: var(--accent-color);
        color: white;
        transition: background-color 0.2s ease;
    }
    .btn-primary:hover {
        background-color: var(--accent-hover);
    }

    .btn-secondary {
        background-color: var(--bg-secondary);
        color: var(--text-main);
        border: 1px solid var(--border-color);
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    .btn-secondary:hover {
        background-color: var(--border-color);
        border-color: var(--text-secondary);
    }

    .btn-click-effect:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    input, select, textarea { 
        background-color: var(--bg-secondary); 
        color: var(--text-main); 
        border: 1px solid var(--border-color);
    }
    input:focus, select:focus, textarea:focus {
        --tw-ring-color: var(--accent-color);
        border-color: var(--accent-color);
    }
    
    .prose { color: var(--text-main); }
    .prose h2, .prose h3 { color: var(--text-main); }
    .prose pre { background-color: var(--bg-main); border: 1px solid var(--border-color); }
    .prose code { color: var(--text-secondary); }
    .prose table th { color: var(--text-main); }
    .prose table td { color: var(--text-secondary); }
    .prose a { color: var(--accent-color); }
    .prose strong { color: var(--text-main); }


    .text-green-custom { color: #4ade80; }
    html.light-mode .text-green-custom { color: #16a34a; }

  </style>
</head>
<body class="min-h-screen">

  <!-- Authentication Container -->
  <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: linear-gradient(rgba(17, 24, 39, 0.8), rgba(17, 24, 39, 0.8)), url('https://placehold.co/1920x1080/111827/111827?text=');">
    <div class="max-w-md w-full glass-effect p-8 rounded-2xl shadow-2xl">
      <img src="https://i.imgur.com/GQya5pg.png" alt="Brand Logo" class="h-20 mx-auto mb-6"/>
      <h2 id="auth-title" class="text-2xl font-bold text-center mb-2 text-white">Member Login</h2>
      <p id="auth-subtitle" class="text-center text-gray-300 mb-6">Access the Supplier Database</p>
      
      <div id="auth-message" class="hidden px-4 py-2 rounded-lg mb-4 text-sm"></div>

      <!-- Login, Signup, Forgot Password Forms -->
      <form id="login-form">
        <div class="mb-4">
          <label for="email" class="block text-sm font-medium text-gray-300">Email Address</label>
          <input type="email" id="email" required class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
        </div>
        <div class="mb-4">
          <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
          <input type="password" id="password" required class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
        </div>
        <button type="button" id="show-forgot-password-btn" class="text-xs text-indigo-400 hover:text-indigo-300 text-right w-full mb-4 -mt-2">Forgot Password?</button>
        <div id="auth-buttons">
          <button type="submit" id="login-btn" class="w-full inline-flex justify-center rounded-md border border-transparent py-2.5 px-4 text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 btn-primary btn-click-effect">Login</button>
          <button type="button" id="show-signup-btn" class="w-full mt-3 text-center text-sm text-indigo-400 hover:text-indigo-300">Don't have an account? Sign Up</button>
        </div>
      </form>

      <form id="signup-form" class="hidden">
        <div class="mb-4">
          <label for="signup-email" class="block text-sm font-medium text-gray-300">Email Address</label>
          <input type="email" id="signup-email" required class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
        </div>
        <div class="mb-6">
          <label for="signup-password" class="block text-sm font-medium text-gray-300">Create Password (min. 6 characters)</label>
          <input type="password" id="signup-password" required class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
        </div>
        <div id="signup-buttons">
          <button type="submit" id="signup-btn" class="w-full inline-flex justify-center rounded-md border border-transparent bg-teal-600 py-2.5 px-4 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-colors btn-click-effect">Create Account</button>
          <button type="button" id="show-login-btn-from-signup" class="w-full mt-3 text-center text-sm text-indigo-400 hover:text-indigo-300">Already have an account? Login</button>
        </div>
      </form>
      
      <form id="forgot-password-form" class="hidden">
        <div class="mb-4">
            <label for="reset-email" class="block text-sm font-medium text-gray-300">Email Address</label>
            <input type="email" id="reset-email" required class="mt-1 block w-full rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
        </div>
        <div id="forgot-password-buttons">
            <button type="submit" id="reset-password-btn" class="w-full inline-flex justify-center rounded-md border border-transparent bg-orange-600 py-2.5 px-4 text-sm font-medium text-white shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors btn-click-effect">Send Reset Link</button>
            <button type="button" id="show-login-btn-from-forgot" class="w-full mt-3 text-center text-sm text-indigo-400 hover:text-indigo-300">Back to Login</button>
        </div>
      </form>

    </div>
  </div>

  <!-- Main Application Container -->
  <div id="main-app-container" class="hidden">
    <!-- Header -->
    <header class="sticky top-0 z-40 w-full glass-effect">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo and Title -->
          <div class="flex items-center space-x-4">
            <img src="https://i.imgur.com/GQya5pg.png" alt="Brand Logo" class="h-8 w-auto"/>
            <span class="hidden sm:block text-xl font-semibold">Supplier Database</span>
          </div>
          
          <!-- Navigation Tabs -->
          <nav class="hidden md:flex items-center space-x-4 border-b border-transparent">
            <button id="tab-database" class="tab-button active px-3 py-5 text-sm font-medium">Database</button>
            <button id="tab-api-docs" class="tab-button px-3 py-5 text-sm font-medium">API Docs</button>
            <button id="tab-api-key" class="tab-button px-3 py-5 text-sm font-medium">API Key</button>
          </nav>

          <!-- User Menu and Theme Toggle -->
          <div class="flex items-center space-x-4">
            <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-gray-700/50 transition-colors btn-click-effect">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <div class="hidden sm:flex items-center space-x-3">
              <span id="user-email-display" class="text-sm"></span>
              <button id="logout-btn" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300">Logout</button>
            </div>
            <!-- Mobile Menu Button can be added here -->
          </div>
        </div>
        <!-- Mobile Navigation Tabs -->
        <nav class="md:hidden flex items-center justify-center space-x-2 border-b border-gray-700 pb-2">
            <button id="mobile-tab-database" class="tab-button active px-4 py-2 text-sm font-medium">Database</button>
            <button id="mobile-tab-api-docs" class="tab-button px-4 py-2 text-sm font-medium">API Docs</button>
            <button id="mobile-tab-api-key" class="tab-button px-4 py-2 text-sm font-medium">API Key</button>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
      <div id="tab-content-container">
        <!-- Database Tab -->
        <div id="database-tab-content" class="tab-content">
          <div id="search-controls" class="glass-effect p-6 rounded-xl shadow-lg mb-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                <div class="md:col-span-4">
                    <label for="search-input" class="block text-sm font-medium mb-1">Search Term</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </div>
                        <input type="text" id="search-input" placeholder="Enter UPC, Item Name, etc." class="block w-full rounded-md shadow-sm sm:text-sm p-2.5 pl-10">
                    </div>
                </div>
                <div class="md:col-span-3">
                    <label for="search-type" class="block text-sm font-medium mb-1">Search By</label>
                    <select id="search-type" class="block w-full rounded-md shadow-sm sm:text-sm p-2.5">
                        <option value="upc" selected>UPC</option>
                        <option value="itemName_lowercase">Item Name</option>
                        <option value="brand">Brand</option>
                        <option value="sku">SKU</option>
                    </select>
                </div>
                <div class="md:col-span-5 flex items-center space-x-3">
                    <button id="search-btn" class="w-full inline-flex justify-center rounded-md py-2.5 px-4 text-sm font-medium btn-primary btn-click-effect">Search</button>
                    <button id="browse-all-btn" class="w-full inline-flex justify-center rounded-md py-2.5 px-4 text-sm font-medium btn-secondary btn-click-effect">Browse All</button>
                </div>
            </div>
            <div id="bulk-search-section" class="mt-4 pt-4 border-t border-[var(--border-color)]">
              <label class="block text-sm font-medium">Bulk UPC Search</label>
              <textarea id="upc-list-input" rows="4" class="mt-1 block w-full rounded-md shadow-sm sm:text-sm p-2" placeholder="Paste a list of UPCs, one per line (up to 500)"></textarea>
              <button id="search-list-btn" class="mt-2 w-full inline-flex justify-center rounded-md border border-transparent bg-teal-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-colors btn-click-effect">Search UPC List</button>
            </div>
          </div>
          
          <div id="controls-bar" class="mb-4 flex justify-end items-center gap-4 hidden">
              <button id="filter-suppliers-btn" type="button" class="inline-flex items-center px-4 py-2 border border-sky-500 text-sm font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700 focus:z-10 focus:outline-none focus:ring-1 focus:ring-sky-500 btn-click-effect">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 000 2h11a1 1 0 100-2H3zM3 7a1 1 0 000 2h5a1 1 0 000-2H3zM3 11a1 1 0 100 2h4a1 1 0 100-2H3zM13 16a1 1 0 102 0v-5.586l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 101.414 1.414L13 10.414V16z" /></svg>
                  Filter Suppliers
              </button>
              <button id="export-csv-btn" type="button" class="inline-flex items-center px-4 py-2 border border-green-600 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:z-10 focus:outline-none focus:ring-1 focus:ring-green-500 btn-click-effect">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                  Export as CSV
              </button>
          </div>

          <div id="loader-container" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
          <div id="export-loader" class="flex justify-center items-center py-20 hidden">
              <div class="loader"></div>
              <p class="ml-4 text-[var(--text-secondary)]">Generating your export file...</p>
          </div>
          <div id="error-display" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-message" class="block sm:inline">Something went wrong.</span>
          </div>

          <div id="results-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
          
          <div id="no-results" class="text-center py-16 text-[var(--text-secondary)]">
            <div class="inline-block bg-[var(--bg-secondary)] p-6 rounded-full">
              <svg class="h-16 w-16 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <h3 id="no-results-title" class="text-xl font-semibold mt-4 text-[var(--text-main)]">No Results Found</h3>
            <p id="no-results-subtitle" class="text-[var(--text-secondary)]">Try a different search term or browse all items.</p>
            <button id="no-results-browse-btn" class="mt-4 inline-flex justify-center rounded-md py-2.5 px-4 text-sm font-medium btn-primary">Browse All Items</button>
          </div>

          <div id="pagination-container" class="mt-10 flex justify-center items-center space-x-2"></div>
        </div>

        <!-- API Docs Tab -->
        <div id="api-docs-tab-content" class="tab-content hidden">
            <div class="glass-effect p-8 rounded-lg prose max-w-none">
                <h2 class="text-2xl font-bold mb-4">API Documentation</h2>
                <p>Use our API to integrate your system with our live product database. All requests must be authenticated using your private API key.</p>
                
                <h3 class="text-xl font-semibold mt-6 mb-2">Authentication</h3>
                <p>Include your API key in the <code>Authorization</code> header for every request. You can generate and manage your key in the "API Key" tab.</p>
                <pre>Authorization: Bearer YOUR_API_KEY</pre>

                <h3 class="text-xl font-semibold mt-6 mb-2">Base URL</h3>
                <pre>https://supplier-api-977359606390.us-central1.run.app</pre>

                <h3 class="text-xl font-semibold mt-6 mb-2">Endpoints & Parameters</h3>
                <p><strong>GET /</strong></p>
                <p>Returns a paginated list of products. You can filter by SKU or UPC.</p>
                <ul class="list-disc list-inside space-y-2 mt-4">
                    <li><code>page</code> (optional, default: 1) - The page number to retrieve.</li>
                    <li><code>limit</code> (optional, default: 250, max: 250) - The number of items to return per page.</li>
                    <li><code>sku</code> (optional) - Filter results for a single product by its SKU.</li>
                    <li><code>upc</code> (optional) - Filter results for a single product by its UPC.</li>
                </ul>

                <h3 class="text-xl font-semibold mt-6 mb-2">Response Format</h3>
                <p>All successful requests will return a JSON object with <code>meta</code> and <code>data</code> keys.</p>
                <pre>{
    "meta": {
        "total": 1287,
        "current_page": 1,
        "total_pages": 6,
        "per_page": 250,
        "rate_limit_remaining": 299
    },
    "data": [
        {
            "sku": "12345",
            "upc": "012345678901",
            "itemName": "Example Perfume",
            "brand": "Designer Brand",
            "size": "100ml",
            "asin": "B08X44T43G",
            "msrp": 95.00,
            "supplier_1_name": "Main Distributor",
            "supplier_1_price": 75.99,
            "supplier_1_inventory": 150,
            "supplier_2_name": "Secondary Wholesaler",
            "supplier_2_price": 78.50,
            "supplier_2_inventory": 45
        },
        ...
    ]
}</pre>
                <h3 class="text-xl font-semibold mt-6 mb-2">Data Object Fields</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-[var(--border-color)]">
                            <tr>
                                <th class="p-2">Field</th>
                                <th class="p-2">Type</th>
                                <th class="p-2">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">sku</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The unique Stock Keeping Unit for the product.</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">upc</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The Universal Product Code.</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">itemName</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The name of the product.</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">brand</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The brand of the product.</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">size</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The size of the product (e.g., "100ml").</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">msrp</td>
                                <td class="p-2">Number</td>
                                <td class="p-2">The Manufacturer's Suggested Retail Price.</td>
                            </tr>
                             <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">asin</td>
                                <td class="p-2">String</td>
                                <td class="p-2">The Amazon Standard Identification Number.</td>
                            </tr>
                            <tr class="border-b border-[var(--border-color)]">
                                <td class="p-2 font-mono">supplier_X_...</td>
                                <td class="p-2">String/Number</td>
                                <td class="p-2">Supplier data is flattened. 'X' is the supplier number, sorted by lowest price first.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold mt-6 mb-2">Error Responses</h3>
                <p>If a request fails, the API will return a JSON object with an <code>error</code> key.</p>
                <ul class="list-disc list-inside space-y-4 mt-4">
                    <li><strong>401 Unauthorized:</strong> The API key is missing, invalid, or has been revoked.<pre class="mt-2">{ "error": "Unauthorized: Invalid API key." }</pre></li>
                    <li><strong>429 Too Many Requests:</strong> The user has exceeded the 100 requests per day limit.<pre class="mt-2">{ "error": "You have exceeded the 100 requests in 24 hrs limit!" }</pre></li>
                    <li><strong>500 Internal Server Error:</strong> An unexpected error occurred on the server.<pre class="mt-2">{ "error": "An unexpected error occurred." }</pre></li>
                </ul>


                <h3 class="text-xl font-semibold mt-6 mb-2">Example Request (cURL)</h3>
                <pre># Get page 2 with 50 items per page
curl -L -X GET "https://supplier-api-977359606390.us-central1.run.app?page=2&limit=50" \
     -H "Authorization: Bearer YOUR_API_KEY"</pre>
                <h3 class="text-xl font-semibold mt-6 mb-2">Example Request (Filtering by SKU)</h3>
                <pre># Get a single product by its SKU
curl -L -X GET "https://supplier-api-977359606390.us-central1.run.app?sku=PRODUCT-SKU-123" \
     -H "Authorization: Bearer YOUR_API_KEY"</pre>
            </div>
        </div>

        <!-- API Key Tab -->
        <div id="api-key-tab-content" class="tab-content hidden">
             <div class="glass-effect p-8 rounded-lg max-w-3xl mx-auto">
                 <!-- API Key Content remains the same -->
                  <h2 class="text-2xl font-bold mb-4">Manage Your API Key</h2>
                  <p class="mb-6">Use this key to authenticate your API requests. Treat it like a password and do not share it publicly.</p>
                  
                  <div id="api-key-loader" class="text-center"><div class="loader inline-block"></div></div>
                  
                  <div id="api-key-content" class="hidden">
                      <div id="api-key-display-area" class="hidden">
                          <label class="block text-sm font-medium">Your API Key</label>
                          <div class="mt-1 relative flex items-center">
                              <input type="password" id="api-key-input" readonly class="block w-full rounded-l-md font-mono p-2.5 pr-10">
                              <button id="toggle-api-key-visibility" class="absolute inset-y-0 right-10 pr-3 flex items-center text-gray-400 hover:text-white">
                                  <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                  </svg>
                                  <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2 2 0 012.828 2.828l1.515 1.515A4 4 0 0014 10a4 4 0 10-5.432-3.432z" clip-rule="evenodd" />
                                      <path d="M10 17a9.953 9.953 0 01-4.542-1.074l-1.78-1.781a1 1 0 011.414-1.414l1.697 1.697A8.018 8.018 0 0110 15c4.478 0 8.268-2.943 9.542-7a10.014 10.014 0 01-1.542-3.31l-1.473-1.473a1 1 0 011.414-1.414l-14-14a1 1 0 01-1.414 1.414l1.78 1.781A9.953 9.953 0 0010 17z" />
                                  </svg>
                              </button>
                              <button id="copy-api-key-btn" class="inline-flex items-center rounded-r-md border border-l-0 px-4 text-sm font-medium btn-secondary">Copy</button>
                          </div>
                          <p id="copy-feedback" class="text-green-custom text-sm mt-2 hidden">Copied!</p>
                          
                          <div class="mt-6 border-t border-[var(--border-color)] pt-6">
                              <p class="text-sm text-yellow-400 bg-yellow-900/30 p-3 rounded-lg"><strong class="font-semibold">Warning:</strong> If you generate a new key, your old key will be immediately revoked. Ensure you update any applications using the old key.</p>
                              <button id="revoke-and-generate-btn" class="mt-4 w-full inline-flex justify-center rounded-md border border-transparent bg-red-600 py-2.5 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 btn-click-effect">Revoke and Generate New Key</button>
                          </div>
                      </div>

                      <div id="generate-key-area" class="hidden">
                          <p class="text-center mb-4">You have not generated an API key yet.</p>
                          <button id="generate-api-key-btn" class="w-full inline-flex justify-center rounded-md py-2.5 px-4 text-sm font-medium btn-primary btn-click-effect">Generate API Key</button>
                      </div>
                  </div>
                  
                  <div class="mt-8 border-t border-[var(--border-color)] pt-6">
                      <h3 class="text-lg font-semibold mb-2">Usage (Last 24 Hours)</h3>
                      <div class="w-full bg-[var(--bg-secondary)] rounded-full h-2.5">
                          <div id="api-usage-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                      </div>
                      <p id="api-usage-text" class="text-right text-sm mt-1">0 / 100 calls</p>

                      <h3 class="text-lg font-semibold mt-6 mb-2">Recent API Calls</h3>
                      <div class="border border-[var(--border-color)] rounded-lg overflow-hidden">
                          <table class="w-full">
                              <thead class="bg-[var(--bg-secondary)]">
                                  <tr>
                                      <th class="p-3 text-sm font-semibold text-left">Timestamp</th>
                                      <th class="p-3 text-sm font-semibold text-left">Status</th>
                                  </tr>
                              </thead>
                              <tbody id="recent-calls-tbody" class="bg-[var(--card-bg)]">
                                  <!-- Rows will be populated by JavaScript -->
                              </tbody>
                          </table>
                      </div>
                  </div>

             </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modals and Lightbox -->
  <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 ease-in-out">
    <div id="modal-overlay" class="absolute inset-0 bg-black/60"></div>
    <div id="modal-content" class="glass-effect rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col relative transform transition-all duration-300 ease-in-out opacity-0 scale-95">
        <button id="modal-close-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white z-10 p-1 rounded-full bg-black/20 hover:bg-black/40">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div id="modal-loader" class="flex justify-center items-center p-10">
            <div class="loader"></div>
        </div>
        <div id="modal-body" class="hidden overflow-y-auto"></div>
    </div>
  </div>

  <div id="image-lightbox" class="fixed inset-0 z-[60] bg-black/80 hidden items-center justify-center">
      <button id="lightbox-close-btn" class="absolute top-6 right-8 text-white text-5xl font-bold">&times;</button>
      <img id="lightbox-img" src="" class="max-w-[90vw] max-h-[90vh] object-contain">
  </div>

  <div id="supplier-filter-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="supplier-modal-overlay" class="absolute inset-0 bg-black/60"></div>
    <div class="glass-effect rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col relative">
        <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)]">
            <h3 class="text-lg font-medium">Filter Suppliers</h3>
            <button id="supplier-modal-close-btn" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="supplier-list-container" class="p-4 overflow-y-auto"></div>
        <div class="p-4 mt-auto border-t border-[var(--border-color)] flex justify-between">
            <div>
                <button id="select-all-suppliers-btn" class="px-4 py-2 text-sm rounded-md btn-secondary">Select All</button>
                <button id="deselect-all-suppliers-btn" class="px-4 py-2 text-sm rounded-md btn-secondary ml-2">Deselect All</button>
            </div>
            <button id="apply-supplier-filter-btn" class="px-4 py-2 text-sm rounded-md btn-primary font-semibold">Apply Filter</button>
        </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyDHhEnfIz2evfEH-Vfpujqnu_MrE57p7v4",
      authDomain: "supplier-database-45001.firebaseapp.com",
      projectId: "supplier-database-45001",
      storageBucket: "supplier-database-45001.appspot.com",
      messagingSenderId: "977359606390",
      appId: "1:977359606390:web:03be683a1e7c7d71bc4557"
    };

    // --- Initialize Firebase ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const productsCollection = db.collection("products");
    const invitedUsersCollection = db.collection("invitedUsers");
    const apiKeysCollection = db.collection("apiKeys");
    const apiLogsCollection = db.collection("apiLogs");

    // --- UI Elements ---
    const authContainer = document.getElementById('auth-container');
    const mainAppContainer = document.getElementById('main-app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    const showSignupBtn = document.getElementById('show-signup-btn');
    const showLoginBtnFromSignup = document.getElementById('show-login-btn-from-signup');
    const showLoginBtnFromForgot = document.getElementById('show-login-btn-from-forgot');
    const showForgotPasswordBtn = document.getElementById('show-forgot-password-btn');
    const authMessageDiv = document.getElementById('auth-message');
    const userEmailDisplay = document.getElementById('user-email-display');
    const logoutBtn = document.getElementById('logout-btn');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const apiKeyDisplayArea = document.getElementById('api-key-display-area');
    const apiKeyInput = document.getElementById('api-key-input');
    const generateKeyArea = document.getElementById('generate-key-area');
    const generateApiKeyBtn = document.getElementById('generate-api-key-btn');
    const copyApiKeyBtn = document.getElementById('copy-api-key-btn');
    const copyFeedback = document.getElementById('copy-feedback');
    const apiKeyLoader = document.getElementById('api-key-loader');
    const apiKeyContent = document.getElementById('api-key-content');
    const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');
    const revokeAndGenerateBtn = document.getElementById('revoke-and-generate-btn');
    const apiUsageBar = document.getElementById('api-usage-bar');
    const apiUsageText = document.getElementById('api-usage-text');
    const recentCallsTbody = document.getElementById('recent-calls-tbody');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const authTitle = document.getElementById('auth-title');
    const authSubtitle = document.getElementById('auth-subtitle');
    
    // --- Theme Logic ---
    const applyTheme = (isLight) => {
        if (isLight) {
            document.documentElement.classList.add('light-mode');
            document.documentElement.classList.remove('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        } else {
            document.documentElement.classList.remove('light-mode');
            document.documentElement.classList.add('dark');
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        }
    };

    themeToggleBtn.addEventListener('click', () => {
        const isLight = document.documentElement.classList.toggle('light-mode');
        document.documentElement.classList.toggle('dark', !isLight);
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        applyTheme(isLight);
    });
    
    const savedTheme = localStorage.getItem('theme');
    applyTheme(savedTheme === 'light');

    // --- Authentication Logic ---
    auth.onAuthStateChanged(user => {
      if (user) {
        authContainer.classList.add('hidden');
        mainAppContainer.classList.remove('hidden');
        userEmailDisplay.textContent = user.email;
        handleBrowseAll();
        loadApiKey(); 
        loadApiUsage();
      } else {
        authContainer.classList.remove('hidden');
        mainAppContainer.classList.add('hidden');
        userEmailDisplay.textContent = '';
      }
    });

    function showAuthMessage(message, type = 'error') {
        authMessageDiv.textContent = message;
        if (type === 'error') {
            authMessageDiv.className = 'bg-red-900/50 border border-red-700 text-red-300 px-4 py-2 rounded-lg mb-4 text-sm';
        } else if (type === 'success') {
            authMessageDiv.className = 'bg-green-900/50 border border-green-700 text-green-300 px-4 py-2 rounded-lg mb-4 text-sm';
        }
        authMessageDiv.classList.remove('hidden');
    }

    function showLoginForm() {
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        forgotPasswordForm.classList.add('hidden');
        authMessageDiv.classList.add('hidden');
        authTitle.textContent = 'Member Login';
        authSubtitle.textContent = 'Access the Supplier Database';
    }

    showSignupBtn.addEventListener('click', () => {
        loginForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        forgotPasswordForm.classList.add('hidden');
        authMessageDiv.classList.add('hidden');
        authTitle.textContent = 'Create Account';
        authSubtitle.textContent = 'Join the Supplier Database';
    });
    
    showForgotPasswordBtn.addEventListener('click', () => {
        loginForm.classList.add('hidden');
        signupForm.classList.add('hidden');
        forgotPasswordForm.classList.remove('hidden');
        authMessageDiv.classList.add('hidden');
        authTitle.textContent = 'Reset Password';
        authSubtitle.textContent = 'Enter your email to get a reset link.';
    });

    showLoginBtnFromSignup.addEventListener('click', showLoginForm);
    showLoginBtnFromForgot.addEventListener('click', showLoginForm);

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          showAuthMessage(error.message, 'error');
        });
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const normalizedEmail = email.toLowerCase();
      console.log("Checking for invited email:", normalizedEmail);

      try {
        const docRef = invitedUsersCollection.doc(normalizedEmail);
        const docSnap = await docRef.get();
        console.log(`Document exists check for ${normalizedEmail}:`, docSnap.exists);

        if (!docSnap.exists) {
          showAuthMessage("Access denied. This email has not been invited.", 'error');
          return;
        }

        await auth.createUserWithEmailAndPassword(email, password);
      } catch (error) {
        console.error("Detailed Signup Error:", error);
        showAuthMessage(`Error: ${error.code} - ${error.message}`, 'error');
      }
    });
    
    forgotPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('reset-email').value;
        showAuthMessage('Sending password reset email...', 'success');
        
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showAuthMessage('Password reset email sent! Please check your inbox.', 'success');
            })
            .catch(error => {
                showAuthMessage(error.message, 'error');
            });
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });
    
    // --- Tab Navigation Logic ---
    function switchTab(tabId) {
        tabButtons.forEach(btn => {
            const btnId = btn.id.replace('mobile-','');
            if (btnId === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        tabContents.forEach(content => {
            if (content.id === tabId.replace('tab-','') + '-tab-content') {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        });
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.id.replace('mobile-','');
            switchTab(tabId);
        });
    });
    
    // --- API Key Management ---
    function generateRandomKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = 'sk_';
        for (let i = 0; i < 32; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    async function loadApiKey() {
        const user = auth.currentUser;
        if (!user) return;

        apiKeyLoader.classList.remove('hidden');
        apiKeyContent.classList.add('hidden');

        try {
            const docRef = apiKeysCollection.doc(user.uid);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                apiKeyInput.value = docSnap.data().key;
                apiKeyDisplayArea.classList.remove('hidden');
                generateKeyArea.classList.add('hidden');
            } else {
                apiKeyDisplayArea.classList.add('hidden');
                generateKeyArea.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error loading API key:", error);
        } finally {
            apiKeyLoader.classList.add('hidden');
            apiKeyContent.classList.remove('hidden');
        }
    }
    
    async function loadApiUsage() {
        const user = auth.currentUser;
        if (!user) return;
        
        const twentyFourHoursAgo = firebase.firestore.Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
        
        try {
            const querySnapshot = await apiLogsCollection
                .where("userId", "==", user.uid)
                .where("timestamp", ">=", twentyFourHoursAgo)
                .get();

            const usageCount = querySnapshot.size;
            const usagePercentage = (usageCount / 300) * 100;
            
            apiUsageText.textContent = `${usageCount} / 300 calls`;
            apiUsageBar.style.width = `${usagePercentage}%`;
            
            recentCallsTbody.innerHTML = '';
            let count = 0;
            querySnapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp).forEach(doc => {
                if (count++ < 10) {
                    const log = doc.data();
                    const date = log.timestamp.toDate();
                    const row = `
                        <tr class="border-b border-[var(--border-color)]">
                            <td class="p-3 text-sm text-[var(--text-secondary)]">${date.toLocaleString()}</td>
                            <td class="p-3 text-sm text-green-custom">Success</td>
                        </tr>
                    `;
                    recentCallsTbody.innerHTML += row;
                }
            });
            if (count === 0) {
                recentCallsTbody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-[var(--text-secondary)]">No API calls in the last 24 hours.</td></tr>';
            }

        } catch (error) {
            console.error("Error loading API usage:", error);
            recentCallsTbody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-red-400">Could not load usage data.</td></tr>';
        }
    }

    async function handleGenerateKey() {
        const user = auth.currentUser;
        if (!user) return;

        const newKey = generateRandomKey();
        apiKeyLoader.classList.remove('hidden');
        apiKeyContent.classList.add('hidden');

        try {
            await apiKeysCollection.doc(user.uid).set({
                key: newKey,
                userId: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await loadApiKey();
        } catch (error) {
            console.error("Error generating API key:", error);
            apiKeyContent.classList.remove('hidden');
        } finally {
            apiKeyLoader.classList.add('hidden');
        }
    }
    
    generateApiKeyBtn.addEventListener('click', handleGenerateKey);
    revokeAndGenerateBtn.addEventListener('click', handleGenerateKey);

    copyApiKeyBtn.addEventListener('click', () => {
        apiKeyInput.select();
        document.execCommand('copy');
        copyFeedback.classList.remove('hidden');
        setTimeout(() => {
            copyFeedback.classList.add('hidden');
        }, 2000);
    });
    
    toggleApiKeyVisibilityBtn.addEventListener('click', () => {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        eyeIcon.classList.toggle('hidden', isPassword);
        eyeOffIcon.classList.toggle('hidden', !isPassword);
    });

    // --- Main Application Logic ---
    const searchInput = document.getElementById('search-input');
    const searchTypeSelect = document.getElementById('search-type');
    const searchBtn = document.getElementById('search-btn');
    const browseAllBtn = document.getElementById('browse-all-btn');
    const loaderContainer = document.getElementById('loader-container');
    const exportLoader = document.getElementById('export-loader');
    const resultsContainer = document.getElementById('results-container');
    const paginationContainer = document.getElementById('pagination-container');
    const noResultsDiv = document.getElementById('no-results');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    const searchControls = document.getElementById('search-controls');
    const controlsBar = document.getElementById('controls-bar');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const filterSuppliersBtn = document.getElementById('filter-suppliers-btn');
    const supplierFilterModal = document.getElementById('supplier-filter-modal');
    const supplierModalOverlay = document.getElementById('supplier-modal-overlay');
    const supplierModalCloseBtn = document.getElementById('supplier-modal-close-btn');
    const supplierListContainer = document.getElementById('supplier-list-container');
    const selectAllSuppliersBtn = document.getElementById('select-all-suppliers-btn');
    const deselectAllSuppliersBtn = document.getElementById('deselect-all-suppliers-btn');
    const applySupplierFilterBtn = document.getElementById('apply-supplier-filter-btn');
    const itemModal = document.getElementById('item-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalLoader = document.getElementById('modal-loader');
    const modalBody = document.getElementById('modal-body');
    const imageLightbox = document.getElementById('image-lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCloseBtn = document.getElementById('lightbox-close-btn');
    const upcListInput = document.getElementById('upc-list-input');
    const searchListBtn = document.getElementById('search-list-btn');
    const noResultsBrowseBtn = document.getElementById('no-results-browse-btn');
    
    let lastVisibleDoc = null;
    let firstVisibleDoc = null;
    let currentPage = 1;
    let currentQueryConstraints = [];
    let currentSearchType = 'browse';
    const ITEMS_PER_PAGE = 100;
    let allSuppliers = new Set();
    let excludedSuppliers = new Set();
    let lastFetchedDocs = [];

    async function fetchData(queryConstraints = [], direction = 'next') {
      showLoader();
      currentQueryConstraints = queryConstraints;

      let query = productsCollection.orderBy('sku').limit(ITEMS_PER_PAGE);
      queryConstraints.forEach(constraint => {
        query = query.where(constraint.field, constraint.op, constraint.value);
      });

      if (direction === 'next' && lastVisibleDoc) {
        query = query.startAfter(lastVisibleDoc);
      } else if (direction === 'prev' && firstVisibleDoc) {
        query = query.endBefore(firstVisibleDoc).limitToLast(ITEMS_PER_PAGE);
      }
      
      try {
        const snapshot = await query.get();
        hideLoader();
        if (snapshot.empty) {
          showNoResults();
          return;
        }
        
        lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
        firstVisibleDoc = snapshot.docs[0];
        lastFetchedDocs = snapshot.docs.map(doc => doc.data());

        if (allSuppliers.size === 0) {
            populateAllSuppliersList(lastFetchedDocs);
        }
        
        renderFilteredResults(lastFetchedDocs);

      } catch (err) {
        console.error("Firestore query failed:", err);
        showError({ message: "Could not fetch data from the database. " + err.message });
      }
    }

    function renderFilteredResults(docs) {
        resultsContainer.innerHTML = '';
        docs.forEach((item, index) => {
            const card = createItemCard(item);
            card.style.animationDelay = `${index * 30}ms`; // Staggered animation
            resultsContainer.appendChild(card);
        });

        noResultsDiv.style.display = 'none';
        controlsBar.style.display = 'flex';
        renderPagination();
    }

    function handleSearch() {
      currentSearchType = 'search';
      const searchTerm = searchInput.value.trim();
      const searchType = searchTypeSelect.value;
      if (!searchTerm) {
        alert("Please enter a search term.");
        return;
      }
      currentPage = 1;
      lastVisibleDoc = null;
      firstVisibleDoc = null;
      let constraints = [];
      if (searchType === 'itemName_lowercase') {
          constraints.push({ field: 'itemName_lowercase', op: '>=', value: searchTerm.toLowerCase() });
          constraints.push({ field: 'itemName_lowercase', op: '<=', value: searchTerm.toLowerCase() + '\uf8ff' });
      } else {
          constraints.push({ field: searchType, op: '==', value: searchTerm });
      }
      fetchData(constraints);
    }
    
    async function handleBulkSearch() {
        currentSearchType = 'bulk';
        const upcList = [...new Set(upcListInput.value.split(/[\n,]/).map(upc => upc.trim()).filter(upc => upc))];
        if (upcList.length === 0) {
            alert("Please paste a list of UPCs.");
            return;
        }
        if (upcList.length > 500) {
            alert("Bulk search is limited to 500 UPCs at a time.");
            return;
        }

        showLoader();
        try {
            const allDocs = await fetchAllBulkDocs(upcList);
            hideLoader();
            resultsContainer.innerHTML = '';
            paginationContainer.innerHTML = '';

            if (allDocs.length === 0) {
                showNoResults();
                return;
            }
            lastFetchedDocs = allDocs;
            renderFilteredResults(lastFetchedDocs);

        } catch (err) {
            console.error("Firestore bulk query failed:", err);
            showError({ message: "Could not fetch data for bulk search. " + err.message });
        }
    }

    async function fetchAllBulkDocs(upcList) {
        const chunks = [];
        for (let i = 0; i < upcList.length; i += 10) {
            chunks.push(upcList.slice(i, i + 10));
        }
        const queryPromises = chunks.map(chunk => 
            productsCollection.where('upc', 'in', chunk).get()
        );
        const querySnapshots = await Promise.all(queryPromises);
        const allDocs = [];
        querySnapshots.forEach(snapshot => {
            snapshot.forEach(doc => allDocs.push(doc.data()));
        });
        return allDocs.sort((a, b) => a.sku.localeCompare(b.sku));
    }

    function handleBrowseAll() {
      currentSearchType = 'browse';
      currentPage = 1;
      lastVisibleDoc = null;
      firstVisibleDoc = null;
      fetchData([]);
    }

    async function handleExport() {
        exportLoader.classList.remove('hidden');
        let docsToExport = [];

        try {
            if (currentSearchType === 'bulk') {
                const upcList = [...new Set(upcListInput.value.split(/[\n,]/).map(upc => upc.trim()).filter(upc => upc))];
                if (upcList.length > 0) {
                    docsToExport = await fetchAllBulkDocs(upcList);
                }
            } else {
                let query = productsCollection.orderBy('sku');
                currentQueryConstraints.forEach(constraint => {
                    query = query.where(constraint.field, constraint.op, constraint.value);
                });
                const snapshot = await query.get();
                snapshot.forEach(doc => docsToExport.push(doc.data()));
            }

            if (docsToExport.length === 0) {
                alert("No data to export.");
                exportLoader.classList.add('hidden');
                return;
            }
            
            const filteredForExport = docsToExport.map(item => {
                const filteredSuppliers = item.suppliers.filter(sup => !excludedSuppliers.has(sup.name));
                return {...item, suppliers: filteredSuppliers};
            });

            generateComplexCsv(filteredForExport);

        } catch (err) {
            console.error("Export failed:", err);
            showError({ message: "Could not fetch data for export. " + err.message });
        } finally {
            exportLoader.classList.add('hidden');
        }
    }

    function generateComplexCsv(items) {
        const maxSuppliers = items.reduce((max, item) => Math.max(max, item.suppliers.length), 0);
        const baseHeaders = ["SKU", "UPC", "Item Name", "Brand", "Size", "Type", "Gender", "Description"];
        let csvHeaders = [...baseHeaders];
        for (let i = 1; i <= maxSuppliers; i++) {
            csvHeaders.push(`Supplier ${i} Name`, `Supplier ${i} Price`, `Supplier ${i} Inventory`);
        }
        const rows = items.map(item => {
            const row = [
                item.sku, `="${item.upc}"`, item.itemName, item.brand,
                item.size, item.type, item.gender, item.description
            ];
            const sortedSuppliers = item.suppliers.sort((a, b) => (parseFloat(a.price) || Infinity) - (parseFloat(b.price) || Infinity));
            sortedSuppliers.forEach(sup => {
                row.push(sup.name, sup.price, sup.inventory);
            });
            return row;
        });
        const escapeCell = (cell) => {
            const strCell = String(cell === null || cell === undefined ? "" : cell);
            if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) {
                return `"${strCell.replace(/"/g, '""')}"`;
            }
            return strCell;
        };
        let csvContent = [
            csvHeaders.map(escapeCell).join(','),
            ...rows.map(row => row.map(escapeCell).join(','))
        ].join('\r\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "supplier_report.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function createItemCard(item) {
        var card = document.createElement('div');
        card.className = 'rounded-lg shadow-lg overflow-hidden flex flex-col cursor-pointer result-card';
        card.dataset.sku = item.sku;
        var placeholderImg = 'https://i.imgur.com/IUBzxFv.jpeg';
        var imageWrapper = document.createElement('div');
        imageWrapper.className = 'w-full h-48 bg-white flex items-center justify-center';
        var imgElement = document.createElement('img');
        imgElement.className = 'w-full h-full object-contain';
        imgElement.alt = item.itemName;
        if (item.imageUrl && String(item.imageUrl).trim() !== "") {
            imgElement.src = item.imageUrl;
            imgElement.onerror = function() { this.src = placeholderImg; };
        } else {
            imgElement.src = placeholderImg;
        }
        imageWrapper.appendChild(imgElement);
        card.appendChild(imageWrapper);
        var contentDiv = document.createElement('div');
        contentDiv.className = 'p-4 flex-grow flex flex-col';
        
        var infoHtml = `<h3 class="text-lg font-semibold truncate text-[var(--text-main)]" title="${item.itemName}">${item.itemName}</h3>`;
        
        if(item.upc && String(item.upc).trim() !== "") {
            infoHtml += `<p class="text-xs text-[var(--text-secondary)] mb-1">UPC: ${item.upc}</p>`;
        }
        if(item.brand && String(item.brand).trim() !== "") {
            infoHtml += `<p class="text-sm text-[var(--text-secondary)] mb-1">Brand: ${item.brand}</p>`;
        }
        if(item.size && String(item.size).trim() !== "") {
            infoHtml += `<p class="text-sm text-[var(--text-secondary)] mb-2">Size: ${item.size}</p>`;
        }

        var suppliersHtml = '<div class="mt-auto pt-2 border-t border-[var(--border-color)]">';
        if (item.suppliers && item.suppliers.length > 0) {
            const lowestPriceValue = item.lowestPrice > 0 ? item.lowestPrice : Infinity;
            
            const sortedSuppliers = [...item.suppliers].sort((a, b) => {
                const priceA = parseFloat(a.price) || Infinity;
                const priceB = parseFloat(b.price) || Infinity;
                return priceA - priceB;
            });

            sortedSuppliers.forEach(supplier => {
                const price = parseFloat(supplier.price);
                const priceText = !isNaN(price) ? '$' + price.toFixed(2) : 'N/A';
                const isLowest = (price === lowestPriceValue && price < Infinity);
                const pClass = isLowest ? 'text-green-custom font-bold' : 'text-[var(--text-secondary)]';
                suppliersHtml += `<p class="text-sm ${pClass}">${supplier.name}: ${priceText}</p>`;
            });
        } else {
            suppliersHtml += '<p class="text-sm text-[var(--text-secondary)]">No suppliers available.</p>';
        }
        suppliersHtml += '</div>';
        
        contentDiv.innerHTML = infoHtml + suppliersHtml;
        card.appendChild(contentDiv);
        return card;
    }

    function showLoader() {
        loaderContainer.innerHTML = '';
        for(let i = 0; i < 15; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton-card';
            skeleton.innerHTML = '<div class="skeleton-image"></div><div class="p-4"><div class="skeleton-text w-3/4"></div><div class="skeleton-text w-1/2"></div></div>';
            loaderContainer.appendChild(skeleton);
        }
        loaderContainer.classList.remove('hidden');
        resultsContainer.innerHTML = '';
        noResultsDiv.style.display = 'none';
        errorDisplay.classList.add('hidden');
        controlsBar.style.display = 'none';
    }
    function hideLoader() { loaderContainer.classList.add('hidden'); }
    function showNoResults() {
        resultsContainer.innerHTML = '';
        noResultsDiv.style.display = 'block';
        controlsBar.style.display = 'none';
    }
    function showError(error) {
        hideLoader();
        errorMessage.textContent = error.message || "An unknown error occurred.";
        errorDisplay.classList.remove('hidden');
    }
    function renderPagination() {
        paginationContainer.innerHTML = '';
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '&laquo; Prev';
        prevBtn.className = 'px-3 py-1 rounded-md text-sm font-medium btn-secondary disabled:opacity-50 disabled:cursor-not-allowed';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            currentPage--;
            fetchData(currentQueryConstraints, 'prev');
        };
        const pageInfo = document.createElement('span');
        pageInfo.className = 'px-3 py-1 text-sm text-[var(--text-secondary)]';
        pageInfo.textContent = 'Page ' + currentPage;
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = 'Next &raquo;';
        nextBtn.className = 'px-3 py-1 rounded-md text-sm font-medium btn-secondary';
        nextBtn.onclick = () => {
            currentPage++;
            fetchData(currentQueryConstraints, 'next');
        };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    function populateAllSuppliersList(docs) {
        docs.forEach(item => {
            if(item.suppliers) {
                item.suppliers.forEach(sup => allSuppliers.add(sup.name));
            }
        });
    }

    function populateSupplierFilterModal() {
        supplierListContainer.innerHTML = '';
        const sortedSuppliers = Array.from(allSuppliers).sort();
        sortedSuppliers.forEach(name => {
            const div = document.createElement('div');
            div.className = 'flex items-center mb-2';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `supplier-cb-${name}`;
            checkbox.value = name;
            checkbox.checked = !excludedSuppliers.has(name);
            checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = name;
            label.className = 'ml-3 block text-sm font-medium';
            div.appendChild(checkbox);
            div.appendChild(label);
            supplierListContainer.appendChild(div);
        });
    }

    searchBtn.addEventListener('click', handleSearch);
    browseAllBtn.addEventListener('click', handleBrowseAll);
    searchListBtn.addEventListener('click', handleBulkSearch);
    exportCsvBtn.addEventListener('click', handleExport);
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchBtn.click(); });
    
    filterSuppliersBtn.addEventListener('click', () => {
        populateSupplierFilterModal();
        supplierFilterModal.classList.remove('hidden');
    });

    supplierModalCloseBtn.addEventListener('click', () => supplierFilterModal.classList.add('hidden'));
    supplierModalOverlay.addEventListener('click', () => {
        supplierFilterModal.classList.add('hidden');
    });

    selectAllSuppliersBtn.addEventListener('click', () => {
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });

    deselectAllSuppliersBtn.addEventListener('click', () => {
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    applySupplierFilterBtn.addEventListener('click', () => {
        excludedSuppliers.clear();
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            if (!cb.checked) {
                excludedSuppliers.add(cb.value);
            }
        });
        supplierFilterModal.classList.add('hidden');
        renderFilteredResults(lastFetchedDocs);
    });

    function handleItemClick(event) {
      const card = event.target.closest('.result-card');
      if (!card) return;

      const sku = card.dataset.sku;
      const itemData = lastFetchedDocs.find(doc => doc.sku === sku);

      if (itemData) {
        itemModal.classList.remove('hidden');
        modalLoader.classList.remove('hidden');
        modalBody.classList.add('hidden');
        
        populateItemModal(itemData);
        
        setTimeout(() => {
            itemModal.classList.remove('opacity-0');
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalLoader.classList.add('hidden');
            modalBody.classList.remove('hidden');
        }, 10);
      }
    }

    function populateItemModal(item) {
        const placeholderImg = 'https://i.imgur.com/IUBzxFv.jpeg';
        const imageUrl = (item.imageUrl && String(item.imageUrl).trim() !== "") ? item.imageUrl : placeholderImg;

        const sortedSuppliers = [...item.suppliers].sort((a, b) => {
            const priceA = parseFloat(a.price) || Infinity;
            const priceB = parseFloat(b.price) || Infinity;
            return priceA - priceB;
        });

        let suppliersHtml = '';
        if (sortedSuppliers.length > 0) {
            suppliersHtml = sortedSuppliers.map(supplier => {
                const price = parseFloat(supplier.price);
                const priceText = !isNaN(price) ? `$${price.toFixed(2)}` : 'N/A';
                const inventoryText = supplier.inventory || 'N/A';
                const isLowest = (price === item.lowestPrice && price < Infinity);
                const priceClass = isLowest ? 'text-green-custom font-bold' : '';
                return `
                    <tr class="border-b border-[var(--border-color)]">
                        <td class="p-3 text-sm">${supplier.name}</td>
                        <td class="p-3 text-sm text-center font-mono ${priceClass}">${priceText}</td>
                        <td class="p-3 text-sm text-center font-mono">${inventoryText}</td>
                    </tr>
                `;
            }).join('');
        } else {
            suppliersHtml = '<tr><td colspan="3" class="p-3 text-center text-[var(--text-secondary)]">No supplier information available.</td></tr>';
        }

        const msrpText = (typeof item.msrp === 'number') ? `$${item.msrp.toFixed(2)}` : (item.msrp || 'N/A');

        modalBody.innerHTML = `
          <div class="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1">
                <div class="aspect-square bg-white rounded-lg flex items-center justify-center p-2 shadow-md">
                    <img id="modal-item-image" src="${imageUrl}" alt="${item.itemName}" class="max-w-full max-h-full object-contain cursor-pointer hover:opacity-90 transition-opacity" onerror="this.src='${placeholderImg}'">
                </div>
                <p class="text-xs text-center text-[var(--text-secondary)] mt-2">Click image to enlarge</p>
            </div>
            <div class="md:col-span-2">
                <h2 class="text-2xl font-bold">${item.itemName || 'N/A'}</h2>
                <p class="text-md text-[var(--text-secondary)] mb-4">by ${item.brand || 'Unknown Brand'}</p>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4">
                    <p><strong class="font-semibold">SKU:</strong> <span class="font-mono">${item.sku || 'N/A'}</span></p>
                    <p><strong class="font-semibold">UPC:</strong> <span class="font-mono">${item.upc || 'N/A'}</span></p>
                    <p><strong class="font-semibold">ASIN:</strong> <span class="font-mono">${item.asin || 'N/A'}</span></p>
                    <p><strong class="font-semibold">MSRP:</strong> <span class="font-mono">${msrpText}</span></p>
                    <p><strong class="font-semibold">Size:</strong> <span>${item.size || 'N/A'}</span></p>
                    <p><strong class="font-semibold">Type:</strong> <span>${item.type || 'N/A'}</span></p>
                    <p><strong class="font-semibold">Gender:</strong> <span>${item.gender || 'N/A'}</span></p>
                    <p><strong class="font-semibold">Category:</strong> <span>${item.category || 'N/A'}</span></p>
                </div>
                <p class="text-sm text-[var(--text-secondary)]">${item.description || 'No description provided.'}</p>
            </div>
          </div>
          <div class="px-4 sm:px-6 pb-4 sm:pb-6 mt-4">
            <h3 class="text-lg font-semibold mb-2">Supplier Stock & Pricing</h3>
            <div class="border border-[var(--border-color)] rounded-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-[var(--bg-secondary)]">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-left">Supplier</th>
                            <th class="p-3 text-sm font-semibold text-center">Price</th>
                            <th class="p-3 text-sm font-semibold text-center">Inventory</th>
                        </tr>
                    </thead>
                    <tbody class="bg-[var(--card-bg)]">${suppliersHtml}</tbody>
                </table>
            </div>
          </div>
        `;
        
        document.getElementById('modal-item-image').addEventListener('click', () => {
            lightboxImg.src = imageUrl;
            imageLightbox.classList.remove('hidden');
            imageLightbox.classList.add('flex');
        });
    }
    
    function closeModal() {
        itemModal.classList.add('opacity-0');
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            itemModal.classList.add('hidden');
        }, 300);
    }

    resultsContainer.addEventListener('click', handleItemClick);
    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    lightboxCloseBtn.addEventListener('click', () => {
        imageLightbox.classList.add('hidden');
        imageLightbox.classList.remove('flex');
    });
  </script>
</body>
</html>
