<!DOCTYPE html>
<html class="dark">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Database</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/U4WPjmA.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Libraries for Inventory Tool -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root {
        /* Dark Mode (Default) - Slate Palette */
        --bg-main: #0f172a;       /* slate-900 */
        --bg-secondary: #1e293b;  /* slate-800 */
        --bg-glass: rgba(15, 23, 42, 0.85);
        --text-main: #f1f5f9;     /* slate-100 */
        --text-secondary: #94a3b8; /* slate-400 */
        --border-color: #334155;  /* slate-700 */
        --accent-color: #6366f1;  /* indigo-500 */
        --accent-hover: #4f46e5;  /* indigo-600 */
        --card-bg: #1e293b;       /* slate-800 */
        --input-bg: #0f172a;      /* slate-900 */
    }

    html.light-mode {
        /* Light Mode - Slate Palette */
        --bg-main: #f8fafc;       /* slate-50 */
        --bg-secondary: #ffffff;  /* white */
        --bg-glass: rgba(255, 255, 255, 0.9);
        --text-main: #0f172a;     /* slate-900 */
        --text-secondary: #64748b; /* slate-500 */
        --border-color: #e2e8f0;  /* slate-200 */
        --accent-color: #4f46e5;  /* indigo-600 */
        --accent-hover: #4338ca;  /* indigo-700 */
        --card-bg: #ffffff;       /* white */
        --input-bg: #ffffff;      /* white */
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background-color: var(--bg-main);
        color: var(--text-main);
        transition: background-color 0.2s ease, color 0.2s ease;
        font-size: 0.9rem;
    }
    
    .glass-effect {
        background-color: var(--bg-glass);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-color);
    }

    /* Clean Abstract Background for Login */
    .auth-bg {
        background-color: var(--bg-main);
        background-image: 
            radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%), 
            radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.08), transparent 25%);
    }

    .loader { border: 3px solid var(--border-color); border-top: 3px solid var(--accent-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .skeleton-card { background-color: var(--bg-secondary); border-radius: 0.5rem; overflow: hidden; border: 1px solid var(--border-color); }
    .skeleton-image { background-color: var(--border-color); opacity: 0.1; height: 10rem; }
    .skeleton-text { background-color: var(--border-color); opacity: 0.1; height: 0.75rem; margin-bottom: 0.5rem; border-radius: 0.25rem; }
    @keyframes pulse { 50% { opacity: .7; } }
    .skeleton-card, .skeleton-image, .skeleton-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    .result-card { 
        opacity: 0; 
        transform: translateY(10px); 
        animation: card-fade-in 0.4s forwards; 
        transition: all 0.2s ease-in-out;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
    }
    .result-card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border-color: var(--accent-color);
    }
    @keyframes card-fade-in { to { opacity: 1; transform: translateY(0); } }
    
    .nav-tab {
        position: relative;
        color: var(--text-secondary);
        transition: all 0.2s ease;
        border-radius: 9999px;
    }
    .nav-tab:hover { color: var(--text-main); background-color: var(--border-color); }
    .nav-tab.active { 
        color: white; 
        background-color: var(--accent-color); 
        font-weight: 500;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    
    .btn-primary {
        background-color: var(--accent-color);
        color: white;
    }
    .btn-primary:hover { background-color: var(--accent-hover); }

    .btn-secondary {
        background-color: transparent;
        color: var(--text-main);
        border: 1px solid var(--border-color);
    }
    .btn-secondary:hover {
        background-color: var(--bg-secondary);
        border-color: var(--text-secondary);
    }
    
    input, select, textarea { 
        background-color: var(--input-bg); 
        color: var(--text-main); 
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.15s;
    }
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 1px var(--accent-color);
    }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

    .text-green-custom { color: #10b981; }
    html.light-mode .text-green-custom { color: #059669; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Authentication Container -->
  <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 auth-bg">
    <div class="max-w-sm w-full bg-[var(--bg-secondary)] border border-[var(--border-color)] p-8 rounded-2xl shadow-2xl">
      <div class="text-center mb-6">
          <img src="https://i.imgur.com/U4WPjmA.png" alt="Logo" class="h-12 w-auto mx-auto mb-3"/>
          <h2 id="auth-title" class="text-xl font-bold text-[var(--text-main)]">Welcome Back</h2>
          <p id="auth-subtitle" class="text-sm text-[var(--text-secondary)]">Sign in to access the database</p>
      </div>
      
      <div id="auth-message" class="hidden px-3 py-2 rounded-md mb-4 text-xs font-medium bg-red-500/10 text-red-500 border border-red-500/20"></div>

      <!-- Login Forms -->
      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Email</label>
          <input type="email" id="email" required class="w-full p-2.5">
        </div>
        <div>
          <label class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Password</label>
          <input type="password" id="password" required class="w-full p-2.5">
        </div>
        <div class="flex justify-end">
            <button type="button" id="show-forgot-password-btn" class="text-xs text-[var(--accent-color)] hover:underline">Forgot Password?</button>
        </div>
        <button type="submit" id="login-btn" class="btn btn-primary w-full py-2.5">Sign In</button>
        <div class="text-center mt-4">
            <button type="button" id="show-signup-btn" class="text-xs text-[var(--text-secondary)] hover:text-[var(--text-main)] transition-colors">Create an account</button>
        </div>
      </form>

      <form id="signup-form" class="hidden space-y-4">
        <div>
          <label class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Email</label>
          <input type="email" id="signup-email" required class="w-full p-2.5">
        </div>
        <div>
          <label class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Password (min 6 chars)</label>
          <input type="password" id="signup-password" required class="w-full p-2.5">
        </div>
        <button type="submit" id="signup-btn" class="btn btn-primary w-full py-2.5">Create Account</button>
        <div class="text-center mt-4">
            <button type="button" id="show-login-btn-from-signup" class="text-xs text-[var(--text-secondary)] hover:text-[var(--text-main)]">Back to Login</button>
        </div>
      </form>
      
      <form id="forgot-password-form" class="hidden space-y-4">
        <div>
            <label class="block text-xs font-medium text-[var(--text-secondary)] mb-1">Email</label>
            <input type="email" id="reset-email" required class="w-full p-2.5">
        </div>
        <button type="submit" id="reset-password-btn" class="btn btn-primary w-full py-2.5">Send Reset Link</button>
        <div class="text-center mt-4">
            <button type="button" id="show-login-btn-from-forgot" class="text-xs text-[var(--text-secondary)] hover:text-[var(--text-main)]">Back to Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Application Container -->
  <div id="main-app-container" class="hidden flex-1 flex flex-col">
    <!-- Compact Header -->
    <header class="sticky top-0 z-40 w-full glass-effect h-14">
      <div class="container mx-auto px-4 h-full flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center space-x-3">
          <img src="https://i.imgur.com/U4WPjmA.png" alt="Logo" class="h-6 w-auto"/>
          <span class="hidden sm:block text-sm font-bold tracking-tight">SUPPLIER DB</span>
        </div>
        
        <!-- Compact Nav -->
        <nav class="hidden md:flex items-center space-x-1">
          <button id="tab-database" class="nav-tab active px-4 py-1.5 text-xs">Database</button>
          <button id="tab-inventory-nexus" class="nav-tab px-4 py-1.5 text-xs">Inventory Nexus</button>
          <button id="tab-api-docs" class="nav-tab px-4 py-1.5 text-xs">API Docs</button>
          <button id="tab-api-key" class="nav-tab px-4 py-1.5 text-xs">API Key</button>
        </nav>

        <!-- Tools -->
        <div class="flex items-center space-x-3">
          <button id="theme-toggle-btn" class="p-1.5 rounded-full text-[var(--text-secondary)] hover:text-[var(--text-main)] hover:bg-[var(--border-color)] transition-colors">
              <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
          </button>
          <div class="h-4 w-px bg-[var(--border-color)] mx-2"></div>
          <span id="user-email-display" class="hidden sm:block text-xs font-medium text-[var(--text-secondary)]"></span>
          <button id="logout-btn" class="text-xs font-semibold text-red-400 hover:text-red-500 ml-2">Logout</button>
        </div>
      </div>
      
      <!-- Mobile Nav -->
      <div class="md:hidden border-t border-[var(--border-color)] flex justify-around p-1 bg-[var(--bg-main)]">
          <button id="mobile-tab-database" class="nav-tab active flex-1 py-2 text-xs">Database</button>
          <button id="mobile-tab-inventory-nexus" class="nav-tab flex-1 py-2 text-xs">Inv. Nexus</button>
          <button id="mobile-tab-api-docs" class="nav-tab flex-1 py-2 text-xs">Docs</button>
          <button id="mobile-tab-api-key" class="nav-tab flex-1 py-2 text-xs">Key</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 container mx-auto p-4 lg:p-6">
      <div id="tab-content-container">
        
        <!-- Database Tab -->
        <div id="database-tab-content" class="tab-content">
          
          <!-- Compact Search Bar -->
          <div class="bg-[var(--card-bg)] border border-[var(--border-color)] p-4 rounded-xl shadow-sm mb-6">
            <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-grow relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <input type="text" id="search-input" placeholder="Search by UPC, Name, Brand..." class="w-full pl-9 py-2">
                </div>
                <div class="w-full md:w-40">
                    <select id="search-type" class="w-full py-2">
                        <option value="upc" selected>UPC</option>
                        <option value="itemName_lowercase">Name</option>
                        <option value="brand">Brand</option>
                        <option value="sku">SKU</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="search-btn" class="btn btn-primary px-6 py-2">Search</button>
                    <button id="browse-all-btn" class="btn btn-secondary px-4 py-2 whitespace-nowrap">Browse All</button>
                </div>
            </div>
            
            <!-- Collapsible Filters/Tools -->
            <div class="mt-4 pt-3 border-t border-[var(--border-color)] flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                     <button id="filter-suppliers-btn" class="btn btn-secondary py-1.5 px-3 text-xs">
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        Filter Suppliers
                     </button>
                     <button id="export-csv-btn" class="btn btn-secondary py-1.5 px-3 text-xs text-green-600 hover:bg-green-50/10 border-green-600/30">
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Export CSV
                     </button>
                </div>
                <!-- Bulk Search Toggle (Could be expanded) -->
                 <details class="w-full md:w-auto relative group">
                    <summary class="list-none cursor-pointer text-xs font-medium text-[var(--accent-color)] hover:underline flex items-center">
                        Advanced: Bulk Search
                        <svg class="w-3 h-3 ml-1 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="absolute right-0 mt-2 w-72 bg-[var(--card-bg)] border border-[var(--border-color)] rounded-lg shadow-xl p-3 z-20">
                        <textarea id="upc-list-input" rows="4" class="w-full text-xs p-2 mb-2" placeholder="Paste UPCs (one per line)"></textarea>
                        <button id="search-list-btn" class="btn btn-primary w-full py-1.5 text-xs">Search List</button>
                    </div>
                 </details>
            </div>
          </div>

          <!-- Loading State -->
          <div id="loader-container" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
          <div id="export-loader" class="flex justify-center items-center py-12 hidden">
             <div class="loader mr-3"></div>
             <p class="text-sm text-[var(--text-secondary)]">Generating CSV...</p>
          </div>
          
          <!-- Error State -->
          <div id="error-display" class="hidden bg-red-500/10 border border-red-500/20 text-red-500 px-4 py-3 rounded-lg mb-6 text-sm flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="error-message">Error</span>
          </div>

          <!-- Results Grid -->
          <div id="results-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
          
          <!-- No Results -->
          <div id="no-results" class="text-center py-20 text-[var(--text-secondary)] hidden">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[var(--bg-secondary)] mb-4">
              <svg class="h-8 w-8 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <h3 id="no-results-title" class="text-lg font-bold text-[var(--text-main)]">No Products Found</h3>
            <p id="no-results-subtitle" class="text-sm mb-4">Try adjusting your search terms.</p>
            <button id="no-results-browse-btn" class="btn btn-secondary px-6 py-2">Clear Search</button>
          </div>

          <!-- Pagination -->
          <div id="pagination-container" class="mt-8 flex justify-center items-center space-x-2"></div>
        </div>

        <!-- Inventory Nexus Tab Content -->
        <div id="inventory-nexus-tab-content" class="tab-content hidden">
            <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-xl p-8 max-w-4xl mx-auto text-center">
                <div class="inline-block p-4 rounded-full bg-[var(--bg-secondary)] mb-6">
                   <!-- Icon -->
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                   </svg>
                </div>
                <h2 class="text-3xl font-bold mb-4 text-[var(--text-main)]">Inventory Nexus</h2>
                <p class="text-lg text-[var(--text-secondary)] mb-8 max-w-2xl mx-auto">
                    A powerful extension tool designed to streamline your inventory management. Upload your own inventory files, map data columns, and consolidate information efficiently.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 text-left max-w-3xl mx-auto">
                    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-color)] hover:border-[var(--accent-color)] transition-colors duration-200">
                        <h3 class="font-bold text-[var(--text-main)] mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-green-custom" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Upload & Map
                        </h3>
                        <p class="text-sm text-[var(--text-secondary)]">Seamlessly upload inventory files (CSV/Excel) and map columns to your specific needs.</p>
                    </div>
                    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-color)] hover:border-[var(--accent-color)] transition-colors duration-200">
                        <h3 class="font-bold text-[var(--text-main)] mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            Bulk Search & Extract
                        </h3>
                        <p class="text-sm text-[var(--text-secondary)]">Perform bulk UPC searches against your uploaded data and extract results instantly.</p>
                    </div>
                </div>

                <a href="https://inventorynexus.brnddirect.com/" target="_blank" class="inline-flex items-center justify-center px-8 py-4 text-base font-bold text-white transition-all duration-200 bg-[var(--accent-color)] border border-transparent rounded-full shadow-lg hover:bg-[var(--accent-hover)] hover:shadow-xl hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Launch Inventory Nexus
                    <svg class="w-5 h-5 ml-2 -mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>
            </div>
        </div>

        <!-- API Docs Tab -->
        <div id="api-docs-tab-content" class="tab-content hidden">
            <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-xl p-6 md:p-10 max-w-4xl mx-auto prose prose-sm prose-slate dark:prose-invert">
                <h2 class="text-2xl font-bold mb-4">API Documentation</h2>
                <p>Integrate your system directly with our live inventory. Authenticate using your private key from the API Key tab.</p>
                
                <h3 class="text-lg font-semibold mt-6 mb-2">Authentication</h3>
                <pre class="rounded-lg p-4 bg-[var(--bg-main)] overflow-x-auto text-xs">Authorization: Bearer YOUR_API_KEY</pre>

                <h3 class="text-lg font-semibold mt-6 mb-2">Base URL</h3>
                <pre class="rounded-lg p-4 bg-[var(--bg-main)] overflow-x-auto text-xs">https://supplier-api-977359606390.us-central1.run.app</pre>

                <h3 class="text-lg font-semibold mt-6 mb-2">Endpoints</h3>
                <p><strong>GET /</strong> - Retrieve products.</p>
                <ul class="list-disc list-inside space-y-1">
                    <li><code>limit</code> (max: 250)</li>
                    <li><code>sku</code>, <code>upc</code> (Exact match)</li>
                    <li><code>cursor</code> (Pagination)</li>
                </ul>
                
                <h3 class="text-lg font-semibold mt-6 mb-2">Response Format</h3>
                <p>All successful requests will return a JSON object with <code>meta</code> and <code>data</code> keys.</p>

                <p><strong>General Browsing:</strong></p>
                <pre class="rounded-lg p-4 bg-[var(--bg-main)] overflow-x-auto text-xs">{
    "meta": {
        "rate_limit_remaining": 299,
        "per_page": 250,
        "next_page_cursor": "..." 
    },
    "data": [ ... ]
}</pre>

                <p><strong>Filtered Queries (SKU/UPC):</strong></p>
                <pre class="rounded-lg p-4 bg-[var(--bg-main)] overflow-x-auto text-xs">{
    "meta": {
        "rate_limit_remaining": 298,
        "total": 1,
        "per_page": 250
    },
    "data": [ ... ]
}</pre>

                <h3 class="text-lg font-semibold mt-6 mb-2">Data Fields</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li><code>sku</code>, <code>upc</code>, <code>asin</code> (String) - Identifiers</li>
                    <li><code>itemName</code>, <code>brand</code>, <code>size</code> (String) - Product details</li>
                    <li><code>msrp</code> (Number) - Suggested retail price</li>
                    <li><code>supplier_X_name</code>, <code>supplier_X_price</code>, <code>supplier_X_inventory</code> - Flattened supplier data (sorted by price)</li>
                </ul>

                <h3 class="text-lg font-semibold mt-6 mb-2">Rate Limit</h3>
                <div class="bg-[var(--bg-secondary)] border border-[var(--border-color)] p-3 rounded-lg inline-block">
                    <span class="font-mono text-[var(--accent-color)] font-bold">300</span> requests / 24 hours
                </div>
                
                <h3 class="text-lg font-semibold mt-6 mb-2">Errors</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>401:</strong> Invalid API Key</li>
                    <li><strong>429:</strong> Rate limit exceeded</li>
                    <li><strong>500:</strong> Server error</li>
                </ul>
            </div>
        </div>

        <!-- API Key Tab -->
        <div id="api-key-tab-content" class="tab-content hidden">
             <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-xl p-8 max-w-2xl mx-auto text-center">
                  <h2 class="text-2xl font-bold mb-2">API Access</h2>
                  <p class="text-sm text-[var(--text-secondary)] mb-8">Manage your secret key for external integrations.</p>
                  
                  <div id="api-key-loader" class="hidden"><div class="loader inline-block"></div></div>
                  
                  <div id="api-key-content" class="hidden text-left">
                      <div id="api-key-display-area" class="hidden">
                          <label class="block text-xs font-bold uppercase text-[var(--text-secondary)] mb-1">Your Secret Key</label>
                          <div class="flex items-center gap-2 mb-2">
                              <div class="relative flex-grow">
                                  <input type="password" id="api-key-input" readonly class="w-full pr-10 font-mono text-sm bg-[var(--bg-secondary)]">
                                  <button id="toggle-api-key-visibility" class="absolute right-2 top-2 text-[var(--text-secondary)] hover:text-[var(--text-main)]">
                                      <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                  </button>
                              </div>
                              <button id="copy-api-key-btn" class="btn btn-secondary px-4 py-2">Copy</button>
                          </div>
                          <p id="copy-feedback" class="text-xs text-green-500 font-bold hidden mb-6">Copied to clipboard!</p>
                          
                          <button id="revoke-and-generate-btn" class="text-xs text-red-400 hover:text-red-500 underline">Revoke & Generate New Key</button>
                      </div>

                      <div id="generate-key-area" class="hidden text-center py-8">
                          <button id="generate-api-key-btn" class="btn btn-primary px-6 py-3 shadow-lg">Generate New API Key</button>
                      </div>
                  </div>
                  
                  <div class="mt-8 pt-8 border-t border-[var(--border-color)] text-left">
                      <div class="flex justify-between items-end mb-2">
                          <h3 class="text-sm font-bold">Usage Quota</h3>
                          <span id="api-usage-text" class="text-xs font-mono text-[var(--text-secondary)]">0 / 300</span>
                      </div>
                      <div class="w-full bg-[var(--bg-secondary)] rounded-full h-1.5 overflow-hidden mb-6">
                          <div id="api-usage-bar" class="bg-[var(--accent-color)] h-full transition-all duration-500" style="width: 0%"></div>
                      </div>

                      <h3 class="text-sm font-bold mb-2">Recent Activity</h3>
                      <div class="border border-[var(--border-color)] rounded-lg overflow-hidden text-xs">
                          <table class="w-full">
                              <thead class="bg-[var(--bg-secondary)] text-[var(--text-secondary)]">
                                  <tr><th class="p-2 text-left font-normal">Time</th><th class="p-2 text-right font-normal">Status</th></tr>
                              </thead>
                              <tbody id="recent-calls-tbody" class="divide-y divide-[var(--border-color)]">
                                  <!-- JS Populated -->
                              </tbody>
                          </table>
                      </div>
                  </div>
             </div>
        </div>
      </div>
    </main>
  </div>

  <!-- --- MODALS --- -->
  
  <!-- Item Details Modal (Updated Table) -->
  <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 ease-in-out">
    <div id="modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div id="modal-content" class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col relative transform transition-all duration-300 ease-in-out opacity-0 scale-95 overflow-hidden">
        <div class="absolute top-0 right-0 p-4 z-10">
             <button id="modal-close-btn" class="bg-[var(--bg-main)] p-1.5 rounded-full text-[var(--text-secondary)] hover:text-white hover:bg-red-500 transition-colors">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="modal-loader" class="flex justify-center items-center p-20"><div class="loader"></div></div>
        <div id="modal-body" class="hidden overflow-y-auto custom-scrollbar"></div>
    </div>
  </div>

  <!-- Image Lightbox -->
  <div id="image-lightbox" class="fixed inset-0 z-[60] bg-black/90 hidden items-center justify-center backdrop-blur-md">
      <button id="lightbox-close-btn" class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors">
        <svg class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
      <img id="lightbox-img" src="" class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg shadow-2xl">
  </div>

  <!-- Supplier Filter Modal -->
  <div id="supplier-filter-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div id="supplier-modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="bg-[var(--card-bg)] border border-[var(--border-color)] rounded-xl shadow-2xl w-full max-w-sm max-h-[80vh] flex flex-col relative">
        <div class="flex justify-between items-center p-4 border-b border-[var(--border-color)]">
            <h3 class="text-sm font-bold">Filter Suppliers</h3>
            <button id="supplier-modal-close-btn" class="text-[var(--text-secondary)] hover:text-[var(--text-main)]"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
        <div id="supplier-list-container" class="p-4 overflow-y-auto flex-1"></div>
        <div class="p-4 border-t border-[var(--border-color)] bg-[var(--bg-secondary)] flex justify-between gap-3">
            <div class="flex gap-2">
                <button id="select-all-suppliers-btn" class="text-xs text-[var(--text-secondary)] hover:underline">Select All</button>
                <button id="deselect-all-suppliers-btn" class="text-xs text-[var(--text-secondary)] hover:underline">Clear</button>
            </div>
            <button id="apply-supplier-filter-btn" class="btn btn-primary px-4 py-1.5 text-xs">Apply</button>
        </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyDHhEnfIz2evfEH-Vfpujqnu_MrE57p7v4",
      authDomain: "supplier-database-45001.firebaseapp.com",
      projectId: "supplier-database-45001",
      storageBucket: "supplier-database-45001.appspot.com",
      messagingSenderId: "977359606390",
      appId: "1:977359606390:web:03be683a1e7c7d71bc4557"
    };

    // --- Initialize Firebase ---
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const productsCollection = db.collection("products");
    const invitedUsersCollection = db.collection("invitedUsers");
    const apiKeysCollection = db.collection("apiKeys");
    const apiLogsCollection = db.collection("apiLogs");

    // --- UI Elements ---
    const authContainer = document.getElementById('auth-container');
    const mainAppContainer = document.getElementById('main-app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const forgotPasswordForm = document.getElementById('forgot-password-form');
    const showSignupBtn = document.getElementById('show-signup-btn');
    const showLoginBtnFromSignup = document.getElementById('show-login-btn-from-signup');
    const showLoginBtnFromForgot = document.getElementById('show-login-btn-from-forgot');
    const showForgotPasswordBtn = document.getElementById('show-forgot-password-btn');
    const authMessageDiv = document.getElementById('auth-message');
    const userEmailDisplay = document.getElementById('user-email-display');
    const logoutBtn = document.getElementById('logout-btn');
    const tabButtons = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const apiKeyDisplayArea = document.getElementById('api-key-display-area');
    const apiKeyInput = document.getElementById('api-key-input');
    const generateKeyArea = document.getElementById('generate-key-area');
    const generateApiKeyBtn = document.getElementById('generate-api-key-btn');
    const copyApiKeyBtn = document.getElementById('copy-api-key-btn');
    const copyFeedback = document.getElementById('copy-feedback');
    const apiKeyLoader = document.getElementById('api-key-loader');
    const apiKeyContent = document.getElementById('api-key-content');
    const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');
    const revokeAndGenerateBtn = document.getElementById('revoke-and-generate-btn');
    const apiUsageBar = document.getElementById('api-usage-bar');
    const apiUsageText = document.getElementById('api-usage-text');
    const recentCallsTbody = document.getElementById('recent-calls-tbody');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');
    const authTitle = document.getElementById('auth-title');
    const authSubtitle = document.getElementById('auth-subtitle');
    
    // --- Theme Logic ---
    const applyTheme = (isLight) => {
        if (isLight) {
            document.documentElement.classList.add('light-mode');
            document.documentElement.classList.remove('dark');
            sunIcon.classList.remove('hidden');
            moonIcon.classList.add('hidden');
        } else {
            document.documentElement.classList.remove('light-mode');
            document.documentElement.classList.add('dark');
            sunIcon.classList.add('hidden');
            moonIcon.classList.remove('hidden');
        }
    };

    themeToggleBtn.addEventListener('click', () => {
        const isLight = document.documentElement.classList.toggle('light-mode');
        document.documentElement.classList.toggle('dark', !isLight);
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        applyTheme(isLight);
    });
    
    const savedTheme = localStorage.getItem('theme');
    applyTheme(savedTheme === 'light');

    // --- Authentication Logic ---
    auth.onAuthStateChanged(user => {
      if (user) {
        authContainer.classList.add('hidden');
        mainAppContainer.classList.remove('hidden');
        userEmailDisplay.textContent = user.email;
        handleBrowseAll();
        loadApiKey(); 
        loadApiUsage();
      } else {
        authContainer.classList.remove('hidden');
        mainAppContainer.classList.add('hidden');
        userEmailDisplay.textContent = '';
      }
    });

    function showAuthMessage(message, type = 'error') {
        authMessageDiv.textContent = message;
        if (type === 'error') {
            authMessageDiv.className = 'px-3 py-2 rounded-md mb-4 text-xs font-medium bg-red-500/10 text-red-500 border border-red-500/20';
        } else if (type === 'success') {
            authMessageDiv.className = 'px-3 py-2 rounded-md mb-4 text-xs font-medium bg-green-500/10 text-green-500 border border-green-500/20';
        }
        authMessageDiv.classList.remove('hidden');
    }

    // Auth Form Toggling
    const forms = [loginForm, signupForm, forgotPasswordForm];
    const hideAllForms = () => forms.forEach(f => f.classList.add('hidden'));

    showSignupBtn.addEventListener('click', () => { hideAllForms(); signupForm.classList.remove('hidden'); authTitle.textContent = 'Create Account'; authSubtitle.textContent = 'Join the database'; authMessageDiv.classList.add('hidden');});
    showForgotPasswordBtn.addEventListener('click', () => { hideAllForms(); forgotPasswordForm.classList.remove('hidden'); authTitle.textContent = 'Reset Password'; authSubtitle.textContent = 'Recover your account'; authMessageDiv.classList.add('hidden');});
    [showLoginBtnFromSignup, showLoginBtnFromForgot].forEach(btn => btn.addEventListener('click', () => { hideAllForms(); loginForm.classList.remove('hidden'); authTitle.textContent = 'Welcome Back'; authSubtitle.textContent = 'Sign in to access'; authMessageDiv.classList.add('hidden');}));

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
        .catch(error => {
          showAuthMessage(error.message, 'error');
        });
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const normalizedEmail = email.toLowerCase();
      try {
        const docRef = invitedUsersCollection.doc(normalizedEmail);
        const docSnap = await docRef.get();
        if (!docSnap.exists) {
          showAuthMessage("Access denied. Email not invited.", 'error');
          return;
        }
        await auth.createUserWithEmailAndPassword(email, password);
      } catch (error) {
        showAuthMessage(error.message, 'error');
      }
    });
    
    forgotPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('reset-email').value;
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showAuthMessage('Reset link sent!', 'success');
            })
            .catch(error => {
                showAuthMessage(error.message, 'error');
            });
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });
    
    // --- Tab Navigation Logic ---
    function switchTab(tabId) {
        tabButtons.forEach(btn => {
            const btnId = btn.id.replace('mobile-','');
            if (btnId === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        tabContents.forEach(content => {
            if (content.id === tabId.replace('tab-','') + '-tab-content') {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        });
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.id.replace('mobile-','');
            switchTab(tabId);
        });
    });
    
    // --- API Key Management ---
    function generateRandomKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = 'sk_';
        for (let i = 0; i < 32; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    async function loadApiKey() {
        const user = auth.currentUser;
        if (!user) return;

        apiKeyLoader.classList.remove('hidden');
        apiKeyContent.classList.add('hidden');

        try {
            const docRef = apiKeysCollection.doc(user.uid);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                apiKeyInput.value = docSnap.data().key;
                apiKeyDisplayArea.classList.remove('hidden');
                generateKeyArea.classList.add('hidden');
            } else {
                apiKeyDisplayArea.classList.add('hidden');
                generateKeyArea.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error loading API key:", error);
        } finally {
            apiKeyLoader.classList.add('hidden');
            apiKeyContent.classList.remove('hidden');
        }
    }
    
    async function loadApiUsage() {
        const user = auth.currentUser;
        if (!user) return;
        
        const twentyFourHoursAgo = firebase.firestore.Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
        
        try {
            const querySnapshot = await apiLogsCollection
                .where("userId", "==", user.uid)
                .where("timestamp", ">=", twentyFourHoursAgo)
                .get();

            const usageCount = querySnapshot.size;
            const usagePercentage = (usageCount / 300) * 100; // Limit updated to 300
            
            apiUsageText.textContent = `${usageCount} / 300 calls`;
            apiUsageBar.style.width = `${usagePercentage}%`;
            
            recentCallsTbody.innerHTML = '';
            let count = 0;
            querySnapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp).forEach(doc => {
                if (count++ < 10) {
                    const log = doc.data();
                    const date = log.timestamp.toDate();
                    const row = `
                        <tr class="border-b border-[var(--border-color)] last:border-0">
                            <td class="p-2 text-left">${date.toLocaleString()}</td>
                            <td class="p-2 text-right text-green-custom">Success</td>
                        </tr>
                    `;
                    recentCallsTbody.innerHTML += row;
                }
            });
            if (count === 0) {
                recentCallsTbody.innerHTML = '<tr><td colspan="2" class="p-3 text-center text-[var(--text-secondary)] italic">No recent activity</td></tr>';
            }

        } catch (error) {
            console.error("Error loading API usage:", error);
        }
    }

    async function handleGenerateKey() {
        const user = auth.currentUser;
        if (!user) return;

        const newKey = generateRandomKey();
        apiKeyLoader.classList.remove('hidden');
        apiKeyContent.classList.add('hidden');

        try {
            await apiKeysCollection.doc(user.uid).set({
                key: newKey,
                userId: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await loadApiKey();
        } catch (error) {
            console.error("Error generating API key:", error);
            apiKeyContent.classList.remove('hidden');
        } finally {
            apiKeyLoader.classList.add('hidden');
        }
    }
    
    generateApiKeyBtn.addEventListener('click', handleGenerateKey);
    revokeAndGenerateBtn.addEventListener('click', handleGenerateKey);

    copyApiKeyBtn.addEventListener('click', () => {
        apiKeyInput.select();
        document.execCommand('copy');
        copyFeedback.classList.remove('hidden');
        setTimeout(() => {
            copyFeedback.classList.add('hidden');
        }, 2000);
    });
    
    toggleApiKeyVisibilityBtn.addEventListener('click', () => {
        const isPassword = apiKeyInput.type === 'password';
        apiKeyInput.type = isPassword ? 'text' : 'password';
        eyeIcon.classList.toggle('hidden', isPassword);
        eyeOffIcon.classList.toggle('hidden', !isPassword);
    });

    // --- Main Application Logic ---
    const searchInput = document.getElementById('search-input');
    const searchTypeSelect = document.getElementById('search-type');
    const searchBtn = document.getElementById('search-btn');
    const browseAllBtn = document.getElementById('browse-all-btn');
    const loaderContainer = document.getElementById('loader-container');
    const exportLoader = document.getElementById('export-loader');
    const resultsContainer = document.getElementById('results-container');
    const paginationContainer = document.getElementById('pagination-container');
    const noResultsDiv = document.getElementById('no-results');
    const errorDisplay = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    const searchControls = document.getElementById('search-controls');
    const controlsBar = document.getElementById('controls-bar');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const filterSuppliersBtn = document.getElementById('filter-suppliers-btn');
    const supplierFilterModal = document.getElementById('supplier-filter-modal');
    const supplierModalOverlay = document.getElementById('supplier-modal-overlay');
    const supplierModalCloseBtn = document.getElementById('supplier-modal-close-btn');
    const supplierListContainer = document.getElementById('supplier-list-container');
    const selectAllSuppliersBtn = document.getElementById('select-all-suppliers-btn');
    const deselectAllSuppliersBtn = document.getElementById('deselect-all-suppliers-btn');
    const applySupplierFilterBtn = document.getElementById('apply-supplier-filter-btn');
    const itemModal = document.getElementById('item-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalLoader = document.getElementById('modal-loader');
    const modalBody = document.getElementById('modal-body');
    const imageLightbox = document.getElementById('image-lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCloseBtn = document.getElementById('lightbox-close-btn');
    const upcListInput = document.getElementById('upc-list-input');
    const searchListBtn = document.getElementById('search-list-btn');
    const noResultsBrowseBtn = document.getElementById('no-results-browse-btn');
    
    let lastVisibleDoc = null;
    let firstVisibleDoc = null;
    let currentPage = 1;
    let currentQueryConstraints = [];
    let currentSearchType = 'browse';
    const ITEMS_PER_PAGE = 100;
    let allSuppliers = new Set();
    let excludedSuppliers = new Set();
    let lastFetchedDocs = [];

    async function fetchData(queryConstraints = [], direction = 'next') {
      showLoader();
      currentQueryConstraints = queryConstraints;

      let query = productsCollection.orderBy('sku').limit(ITEMS_PER_PAGE);
      queryConstraints.forEach(constraint => {
        query = query.where(constraint.field, constraint.op, constraint.value);
      });

      if (direction === 'next' && lastVisibleDoc) {
        query = query.startAfter(lastVisibleDoc);
      } else if (direction === 'prev' && firstVisibleDoc) {
        query = query.endBefore(firstVisibleDoc).limitToLast(ITEMS_PER_PAGE);
      }
      
      try {
        const snapshot = await query.get();
        hideLoader();
        if (snapshot.empty) {
          showNoResults();
          return;
        }
        
        lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
        firstVisibleDoc = snapshot.docs[0];
        lastFetchedDocs = snapshot.docs.map(doc => doc.data());

        if (allSuppliers.size === 0) {
            populateAllSuppliersList(lastFetchedDocs);
        }
        
        renderFilteredResults(lastFetchedDocs);

      } catch (err) {
        console.error("Firestore query failed:", err);
        showError({ message: "Could not fetch data from the database. " + err.message });
      }
    }

    function renderFilteredResults(docs) {
        if(!resultsContainer) return;
        resultsContainer.innerHTML = '';
        
        const processedDocs = docs.reduce((acc, item) => {
            // 1. Get ALL suppliers that are NOT strictly excluded by the checkbox UI
            // This is our baseline "viewable" list for this user session
            const allowedSuppliers = item.suppliers ? item.suppliers.filter(sup => !excludedSuppliers.has(sup.name)) : [];

            // 2. Determine "Active Filtering" Mode
            const isFilteringActive = excludedSuppliers.size > 0;

            let shouldShowItem = true;

            if (isFilteringActive) {
                 // Requirement: If filtering is active, only show items where at least one 
                 // of the SELECTED suppliers has actual inventory (stock > 0).
                 const hasInventoryInSelected = allowedSuppliers.some(sup => {
                     const stock = parseFloat(String(sup.inventory).replace(/,/g, ''));
                     return !isNaN(stock) && stock > 0;
                 });
                 
                 if (!hasInventoryInSelected) {
                     shouldShowItem = false;
                 }
            }

            if (shouldShowItem) {
                 // Calculate lowest price from ALLOWED suppliers only
                 const newLowestPrice = allowedSuppliers.reduce((min, sup) => {
                    const price = parseFloat(sup.price);
                    const stock = parseFloat(String(sup.inventory).replace(/,/g, ''));
                    const hasStock = !isNaN(stock) && stock > 0;

                    if (hasStock && !isNaN(price) && price > 0 && price < min) {
                        return price;
                    }
                    return min;
                }, Infinity);

                acc.push({
                    ...item,
                    // Pass ALL suppliers to the card so user can compare, 
                    // even if they filtered for specific ones to find the item.
                    suppliers: item.suppliers, 
                    lowestPrice: newLowestPrice === Infinity ? -1 : newLowestPrice
                });
            }
            return acc;
        }, []);

        processedDocs.forEach((item, index) => {
            const card = createItemCard(item);
            card.style.animationDelay = `${index * 30}ms`; // Staggered animation
            resultsContainer.appendChild(card);
        });

        if (processedDocs.length === 0) {
            showNoResults();
        } else {
            if(noResultsDiv) noResultsDiv.classList.add('hidden');
            if(controlsBar) {
                controlsBar.classList.remove('hidden');
                controlsBar.classList.add('flex');
            }
            renderPagination();
        }
    }

    function handleSearch() {
      currentSearchType = 'search';
      const searchTerm = searchInput.value.trim();
      const searchType = searchTypeSelect.value;
      if (!searchTerm) {
        alert("Please enter a search term.");
        return;
      }
      currentPage = 1;
      lastVisibleDoc = null;
      firstVisibleDoc = null;
      let constraints = [];
      if (searchType === 'itemName_lowercase') {
          constraints.push({ field: 'itemName_lowercase', op: '>=', value: searchTerm.toLowerCase() });
          constraints.push({ field: 'itemName_lowercase', op: '<=', value: searchTerm.toLowerCase() + '\uf8ff' });
      } else {
          constraints.push({ field: searchType, op: '==', value: searchTerm });
      }
      fetchData(constraints);
    }
    
    async function handleBulkSearch() {
        currentSearchType = 'bulk';
        const upcList = [...new Set(upcListInput.value.split(/[\n,]/).map(upc => upc.trim()).filter(upc => upc))];
        if (upcList.length === 0) {
            alert("Please paste a list of UPCs.");
            return;
        }
        if (upcList.length > 500) {
            alert("Bulk search is limited to 500 UPCs at a time.");
            return;
        }

        showLoader();
        try {
            const allDocs = await fetchAllBulkDocs(upcList);
            hideLoader();
            resultsContainer.innerHTML = '';
            paginationContainer.innerHTML = '';

            if (allDocs.length === 0) {
                showNoResults();
                return;
            }
            lastFetchedDocs = allDocs;
            renderFilteredResults(lastFetchedDocs);

        } catch (err) {
            console.error("Firestore bulk query failed:", err);
            showError({ message: "Bulk search failed. " + err.message });
        }
    }

    async function fetchAllBulkDocs(upcList) {
        const chunks = [];
        for (let i = 0; i < upcList.length; i += 10) {
            chunks.push(upcList.slice(i, i + 10));
        }
        const queryPromises = chunks.map(chunk => 
            productsCollection.where('upc', 'in', chunk).get()
        );
        const querySnapshots = await Promise.all(queryPromises);
        const allDocs = [];
        querySnapshots.forEach(snapshot => {
            snapshot.forEach(doc => allDocs.push(doc.data()));
        });
        
        // Sort results based on the order of UPCs in the input list
        return allDocs.sort((a, b) => upcList.indexOf(a.upc) - upcList.indexOf(b.upc));
    }

    function handleBrowseAll() {
      currentSearchType = 'browse';
      currentPage = 1;
      lastVisibleDoc = null;
      firstVisibleDoc = null;
      fetchData([]);
    }

    async function handleExport() {
        exportLoader.classList.remove('hidden');
        let docsToExport = [];

        try {
            if (currentSearchType === 'bulk') {
                const upcList = [...new Set(upcListInput.value.split(/[\n,]/).map(upc => upc.trim()).filter(upc => upc))];
                if (upcList.length > 0) {
                    docsToExport = await fetchAllBulkDocs(upcList);
                }
            } else {
                // EXPORT LOGIC: Only export CURRENT PAGE data when in browse mode
                // This saves massive amounts of reads.
                if (lastFetchedDocs && lastFetchedDocs.length > 0) {
                     docsToExport = [...lastFetchedDocs];
                } else {
                     // Fallback: If for some reason lastFetchedDocs is empty (shouldn't happen if user sees data)
                     // Re-fetch current page logic - but to be safe, let's just abort if empty
                     // to prevent accidental full reads.
                     docsToExport = [];
                }
            }

            if (docsToExport.length === 0) {
                alert("No data to export. Please perform a search or load data first.");
                exportLoader.classList.add('hidden');
                return;
            }

            generateMatrixCsv(docsToExport);

        } catch (err) {
            console.error("Export failed:", err);
            showError({ message: "Export failed. " + err.message });
        } finally {
            exportLoader.classList.add('hidden');
        }
    }

    function generateMatrixCsv(items) {
        // 1. Identify all unique suppliers in this dataset to create columns
        const supplierSet = new Set();
        const supplierLastUpdates = {};

        items.forEach(item => {
            if (item.suppliers) {
                item.suppliers.forEach(s => {
                    supplierSet.add(s.name);
                    // Capture last update if available
                    if (s.lastUpdate && !supplierLastUpdates[s.name]) {
                         let dateStr = '';
                         try {
                            const dateObj = s.lastUpdate.toDate ? s.lastUpdate.toDate() : new Date(s.lastUpdate);
                            if (!isNaN(dateObj)) dateStr = dateObj.toLocaleDateString();
                         } catch(e) { dateStr = s.lastUpdate; }
                         supplierLastUpdates[s.name] = dateStr;
                    }
                });
            }
        });

        const sortedSuppliers = Array.from(supplierSet).sort();

        // 2. Build Rows
        // Row 1: Last Updates (aligned with supplier columns)
        let row1 = ["", "", "", "", "", ""]; // Skip basic info cols (UPC, Item Name, Brand, Size, Gender, Category)
        sortedSuppliers.forEach(name => {
             const date = supplierLastUpdates[name] || "";
             row1.push(date, ""); // Two columns per supplier (Price, Inv)
        });

        // Row 2: Supplier Names
        let row2 = ["", "", "", "", "", ""];
        sortedSuppliers.forEach(name => {
            row2.push(name, "");
        });

        // Row 3: Headers
        let row3 = ["UPC", "Item Name", "Brand", "Size", "Gender", "Category"];
        sortedSuppliers.forEach(() => {
            row3.push("Price", "Inventory");
        });

        const escapeCell = (cell) => {
            const strCell = String(cell === null || cell === undefined ? "" : cell);
            if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) {
                return `"${strCell.replace(/"/g, '""')}"`;
            }
            return strCell;
        };

        let csvContent = "";
        csvContent += row1.map(escapeCell).join(",") + "\n";
        csvContent += row2.map(escapeCell).join(",") + "\n";
        csvContent += row3.map(escapeCell).join(",") + "\n";

        // Data Rows
        items.forEach(item => {
            let row = [
                item.upc, 
                item.itemName, 
                item.brand, 
                item.size,
                item.gender,
                item.category
            ];

            sortedSuppliers.forEach(supName => {
                const supData = item.suppliers ? item.suppliers.find(s => s.name === supName) : null;
                if (supData) {
                    row.push(supData.price, supData.inventory);
                } else {
                    row.push("", "");
                }
            });
            csvContent += row.map(escapeCell).join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "supplier_matrix_report.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function createItemCard(item) {
        var card = document.createElement('div');
        card.className = 'result-card rounded-lg overflow-hidden flex flex-col cursor-pointer hover:border-[var(--accent-color)]';
        card.dataset.sku = item.sku;
        
        var placeholderImg = 'https://i.imgur.com/IUBzxFv.jpeg';
        var imgUrl = (item.imageUrl && String(item.imageUrl).trim() !== "") ? item.imageUrl : placeholderImg;

        // Calculate lowest price for display (using pre-filtered suppliers from renderFilteredResults)
        const priceDisplay = item.lowestPrice !== -1 ? `$${item.lowestPrice.toFixed(2)}` : 'N/A';

        // Compact Supplier List (Vertical, Clean)
        let supplierGridHtml = '';
        if (item.suppliers && item.suppliers.length > 0) {
            // Sort by price and take top 3
            const topSuppliers = [...item.suppliers].sort((a,b) => (parseFloat(a.price)||Infinity) - (parseFloat(b.price)||Infinity)).slice(0, 3);
            
            supplierGridHtml = `<div class="mt-auto pt-3 border-t border-[var(--border-color)] flex flex-col gap-1.5">`;
            
            topSuppliers.forEach(s => {
                const p = parseFloat(s.price);
                const pStr = !isNaN(p) ? `$${p.toFixed(2)}` : '-';
                const isLowest = p === item.lowestPrice;
                const stock = s.inventory || 0;
                
                supplierGridHtml += `
                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center gap-2 overflow-hidden">
                             <span class="truncate text-[var(--text-secondary)] font-medium max-w-[80px]" title="${s.name}">${s.name}</span>
                             <span class="text-[10px] text-[var(--text-secondary)]/70 bg-[var(--bg-secondary)] px-1 rounded">Qty: ${stock}</span>
                        </div>
                        <span class="font-mono ${isLowest ? 'text-green-custom font-bold' : 'text-[var(--text-main)]'}">${pStr}</span>
                    </div>`;
            });
            
            if (item.suppliers.length > 3) {
                 supplierGridHtml += `<div class="text-[10px] text-[var(--text-secondary)] text-center pt-1 italic">+${item.suppliers.length - 3} more</div>`;
            }
            supplierGridHtml += `</div>`;
        } else {
             supplierGridHtml = `<div class="mt-auto pt-3 border-t border-[var(--border-color)] text-xs text-[var(--text-secondary)] text-center italic">No active suppliers</div>`;
        }

        card.innerHTML = `
            <div class="w-full h-40 bg-white flex items-center justify-center p-4 relative border-b border-[var(--border-color)]">
                <img src="${imgUrl}" alt="${item.itemName}" class="w-full h-full object-contain" onerror="this.src='${placeholderImg}'">
                <div class="absolute top-2 right-2 bg-black/80 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">
                    ${priceDisplay}
                </div>
            </div>
            <div class="p-3 flex-grow flex flex-col">
                <div class="mb-2">
                    <h3 class="text-sm font-bold leading-snug text-[var(--text-main)] line-clamp-2" title="${item.itemName}">${item.itemName}</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-medium px-1.5 py-0.5 rounded bg-[var(--bg-secondary)] text-[var(--text-secondary)] border border-[var(--border-color)] truncate max-w-[80px]">${item.brand || 'No Brand'}</span>
                         ${item.size ? `<span class="text-[10px] font-mono text-[var(--text-secondary)]">${item.size}</span>` : ''}
                    </div>
                </div>
                ${supplierGridHtml}
            </div>
        `;
        return card;
    }

    function showLoader() {
        if(loaderContainer) {
            loaderContainer.innerHTML = '';
            for(let i = 0; i < 15; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-card';
                skeleton.innerHTML = '<div class="skeleton-image h-40"></div><div class="p-3"><div class="skeleton-text w-3/4 mb-2"></div><div class="skeleton-text w-1/2"></div></div>';
                loaderContainer.appendChild(skeleton);
            }
            loaderContainer.classList.remove('hidden');
        }
        if(resultsContainer) resultsContainer.innerHTML = '';
        if(noResultsDiv) noResultsDiv.classList.add('hidden');
        if(errorDisplay) errorDisplay.classList.add('hidden');
        if(controlsBar) controlsBar.classList.add('hidden');
    }
    
    function hideLoader() { if(loaderContainer) loaderContainer.classList.add('hidden'); }
    
    function showNoResults() {
        if(resultsContainer) resultsContainer.innerHTML = '';
        if(noResultsDiv) noResultsDiv.classList.remove('hidden');
        if(controlsBar) controlsBar.classList.add('hidden');
    }
    
    function showError(error) {
        hideLoader();
        if(errorMessage) errorMessage.textContent = error.message || "An unknown error occurred.";
        if(errorDisplay) errorDisplay.classList.remove('hidden');
    }

    function renderPagination() {
        if(!paginationContainer) return;
        paginationContainer.innerHTML = '';
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '&laquo;';
        prevBtn.className = 'btn btn-secondary px-3 py-1 disabled:opacity-50';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            currentPage--;
            fetchData(currentQueryConstraints, 'prev');
        };
        const pageInfo = document.createElement('span');
        pageInfo.className = 'text-xs text-[var(--text-secondary)] font-mono';
        pageInfo.textContent = 'Pg ' + currentPage;
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '&raquo;';
        nextBtn.className = 'btn btn-secondary px-3 py-1';
        nextBtn.onclick = () => {
            currentPage++;
            fetchData(currentQueryConstraints, 'next');
        };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    function populateAllSuppliersList(docs) {
        docs.forEach(item => {
            if(item.suppliers) {
                item.suppliers.forEach(sup => allSuppliers.add(sup.name));
            }
        });
    }

    function populateSupplierFilterModal() {
        supplierListContainer.innerHTML = '';
        const sortedSuppliers = Array.from(allSuppliers).sort();
        sortedSuppliers.forEach(name => {
            const div = document.createElement('div');
            div.className = 'flex items-center mb-2';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `supplier-cb-${name}`;
            checkbox.value = name;
            checkbox.checked = !excludedSuppliers.has(name);
            checkbox.className = 'w-4 h-4 rounded border-[var(--border-color)] text-[var(--accent-color)] focus:ring-[var(--accent-color)] bg-[var(--input-bg)]';
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = name;
            label.className = 'ml-3 block text-sm text-[var(--text-secondary)]';
            div.appendChild(checkbox);
            div.appendChild(label);
            supplierListContainer.appendChild(div);
        });
    }

    searchBtn.addEventListener('click', handleSearch);
    browseAllBtn.addEventListener('click', handleBrowseAll);
    searchListBtn.addEventListener('click', handleBulkSearch);
    exportCsvBtn.addEventListener('click', handleExport);
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchBtn.click(); });
    noResultsBrowseBtn.addEventListener('click', handleBrowseAll);
    
    filterSuppliersBtn.addEventListener('click', () => {
        populateSupplierFilterModal();
        supplierFilterModal.classList.remove('hidden');
    });

    supplierModalCloseBtn.addEventListener('click', () => supplierFilterModal.classList.add('hidden'));
    supplierModalOverlay.addEventListener('click', () => {
        supplierFilterModal.classList.add('hidden');
    });

    selectAllSuppliersBtn.addEventListener('click', () => {
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
    });

    deselectAllSuppliersBtn.addEventListener('click', () => {
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    applySupplierFilterBtn.addEventListener('click', () => {
        excludedSuppliers.clear();
        supplierListContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            if (!cb.checked) {
                excludedSuppliers.add(cb.value);
            }
        });
        supplierFilterModal.classList.add('hidden');
        renderFilteredResults(lastFetchedDocs);
    });

    function handleItemClick(event) {
      const card = event.target.closest('.result-card');
      if (!card) return;

      const sku = card.dataset.sku;
      const itemData = lastFetchedDocs.find(doc => doc.sku === sku);

      if (itemData) {
        itemModal.classList.remove('hidden');
        modalLoader.classList.remove('hidden');
        modalBody.classList.add('hidden');
        
        populateItemModal(itemData);
        
        setTimeout(() => {
            itemModal.classList.remove('opacity-0');
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalLoader.classList.add('hidden');
            modalBody.classList.remove('hidden');
        }, 10);
      }
    }

    function populateItemModal(item) {
        const placeholderImg = 'https://i.imgur.com/IUBzxFv.jpeg';
        const imageUrl = (item.imageUrl && String(item.imageUrl).trim() !== "") ? item.imageUrl : placeholderImg;

        // Filter based on excluded suppliers
        const visibleSuppliers = item.suppliers ? item.suppliers.filter(s => !excludedSuppliers.has(s.name)) : [];

        // Calculate lowest price among visible suppliers for highlighting
        const lowestVisiblePrice = visibleSuppliers.reduce((min, sup) => {
            const price = parseFloat(sup.price);
            return !isNaN(price) && price > 0 && price < min ? price : min;
        }, Infinity);

        const sortedSuppliers = [...visibleSuppliers].sort((a, b) => {
            const priceA = parseFloat(a.price) || Infinity;
            const priceB = parseFloat(b.price) || Infinity;
            return priceA - priceB;
        });

        let suppliersHtml = '';
        if (sortedSuppliers.length > 0) {
            suppliersHtml = sortedSuppliers.map(supplier => {
                const price = parseFloat(supplier.price);
                const priceText = !isNaN(price) ? `$${price.toFixed(2)}` : 'N/A';
                const inventoryText = supplier.inventory || 'N/A';
                
                // Format Last Update
                let lastUpdateText = 'N/A';
                if (supplier.lastUpdate) {
                    try {
                        const dateObj = supplier.lastUpdate.toDate ? supplier.lastUpdate.toDate() : new Date(supplier.lastUpdate);
                        if (!isNaN(dateObj)) {
                            lastUpdateText = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: '2-digit' });
                        } else {
                             lastUpdateText = supplier.lastUpdate;
                        }
                    } catch (e) {
                        lastUpdateText = supplier.lastUpdate;
                    }
                }

                const isLowest = (price === lowestVisiblePrice && price < Infinity);
                const priceClass = isLowest ? 'text-green-custom font-bold' : 'text-[var(--text-secondary)]';
                return `
                    <tr class="border-b border-[var(--border-color)] hover:bg-[var(--bg-secondary)] transition-colors">
                        <td class="p-3 text-sm text-[var(--text-main)]">${supplier.name}</td>
                        <td class="p-3 text-sm text-center font-mono ${priceClass}">${priceText}</td>
                        <td class="p-3 text-sm text-center font-mono text-[var(--text-secondary)]">${inventoryText}</td>
                        <td class="p-3 text-sm text-center text-[var(--text-secondary)] text-xs">${lastUpdateText}</td>
                    </tr>
                `;
            }).join('');
        } else {
            suppliersHtml = '<tr><td colspan="4" class="p-4 text-center text-[var(--text-secondary)] text-sm italic">No suppliers available for the selected criteria.</td></tr>';
        }

        const msrpText = (typeof item.msrp === 'number') ? `$${item.msrp.toFixed(2)}` : (item.msrp || 'N/A');

        modalBody.innerHTML = `
          <div class="flex flex-col md:flex-row gap-6 p-6">
            <!-- Image Column -->
            <div class="w-full md:w-1/3 flex-shrink-0">
                <div class="aspect-square bg-white rounded-lg flex items-center justify-center p-4 border border-[var(--border-color)] overflow-hidden relative group">
                    <img id="modal-item-image" src="${imageUrl}" alt="${item.itemName}" class="max-w-full max-h-full object-contain cursor-pointer transition-transform duration-300 group-hover:scale-105" onerror="this.src='${placeholderImg}'">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors pointer-events-none"></div>
                </div>
            </div>
            
            <!-- Details Column -->
            <div class="w-full md:w-2/3 flex flex-col">
                <div class="mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-[var(--text-main)] mb-1 leading-tight">${item.itemName || 'N/A'}</h2>
                    <p class="text-sm text-[var(--text-secondary)]">by <span class="font-medium text-[var(--text-main)]">${item.brand || 'Unknown Brand'}</span></p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6 bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-color)]">
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">SKU</span>
                        <span class="font-mono text-sm text-[var(--text-main)] select-all">${item.sku || 'N/A'}</span>
                     </div>
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">UPC</span>
                        <span class="font-mono text-sm text-[var(--text-main)] select-all">${item.upc || 'N/A'}</span>
                     </div>
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">MSRP</span>
                        <span class="font-mono text-sm text-[var(--text-main)]">${msrpText}</span>
                     </div>
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">Size / Type</span>
                        <span class="text-sm text-[var(--text-main)]">${item.size || '-'} / ${item.type || '-'}</span>
                     </div>
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">Gender</span>
                        <span class="text-sm text-[var(--text-main)]">${item.gender || '-'}</span>
                     </div>
                     <div>
                        <span class="block text-xs text-[var(--text-secondary)] uppercase tracking-wider mb-0.5">Category</span>
                        <span class="text-sm text-[var(--text-main)]">${item.category || '-'}</span>
                     </div>
                </div>
                
                <div class="flex-grow">
                    <h3 class="text-sm font-bold text-[var(--text-main)] mb-2">Description</h3>
                    <div class="text-sm text-[var(--text-secondary)] leading-relaxed max-h-32 overflow-y-auto pr-2 custom-scrollbar">
                        ${item.description || 'No description provided.'}
                    </div>
                </div>
            </div>
          </div>
          
          <!-- Table Section -->
          <div class="border-t border-[var(--border-color)] bg-[var(--bg-secondary)]/30">
            <div class="p-4 md:p-6">
                <h3 class="text-sm font-bold text-[var(--text-main)] mb-3 flex items-center">
                    <svg class="w-4 h-4 mr-2 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                    Supplier Pricing & Stock
                </h3>
                <div class="border border-[var(--border-color)] rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-[var(--bg-secondary)] text-[var(--text-secondary)] text-xs uppercase tracking-wider">
                                <th class="p-3 text-left font-medium">Supplier</th>
                                <th class="p-3 text-center font-medium">Price</th>
                                <th class="p-3 text-center font-medium">Stock</th>
                                <th class="p-3 text-center font-medium">Updated</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-[var(--border-color)] bg-[var(--card-bg)]">
                            ${suppliersHtml}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
        `;
        
        document.getElementById('modal-item-image').addEventListener('click', () => {
            lightboxImg.src = imageUrl;
            imageLightbox.classList.remove('hidden');
            imageLightbox.classList.add('flex');
        });
    }
    
    function closeModal() {
        itemModal.classList.add('opacity-0');
        modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            itemModal.classList.add('hidden');
        }, 300);
    }

    resultsContainer.addEventListener('click', handleItemClick);
    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    lightboxCloseBtn.addEventListener('click', () => {
        imageLightbox.classList.add('hidden');
        imageLightbox.classList.remove('flex');
    });
  </script>
</body>
</html>
